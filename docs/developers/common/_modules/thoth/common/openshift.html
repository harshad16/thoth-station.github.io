<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>thoth.common.openshift &#8212; Thoth Common NA documentation</title>
    <link rel="stylesheet" href="../../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../../index.html">Thoth Common NA documentation</a> &#187;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thoth.common.openshift</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># thoth-common</span>
<span class="c1"># Copyright(C) 2018 Fridolin Pokorny</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and / or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Handling OpenShift and Kubernetes objects across project.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">urllib3</span>

<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="k">import</span> <span class="n">NotFoundException</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="k">import</span> <span class="n">ConfigurationError</span>
<span class="kn">from</span> <span class="nn">.helpers</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_service_account_token</span><span class="p">,</span>
    <span class="n">_get_incluster_token_file</span><span class="p">,</span>
    <span class="n">_get_incluster_ca_file</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>
<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="OpenShift"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift">[docs]</a><span class="k">class</span> <span class="nc">OpenShift</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Interaction with OpenShift Master.&quot;&quot;&quot;</span>

    <span class="n">_DEFAULT_WORKLOAD_LABELS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;app&quot;</span><span class="p">:</span> <span class="s2">&quot;thoth&quot;</span><span class="p">,</span> <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;workload&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">frontend_namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">middletier_namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">backend_namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">infra_namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">amun_infra_namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">amun_inspection_namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">kubernetes_api_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">kubernetes_verify_tls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">openshift_api_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cert_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">environ</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize OpenShift class responsible for handling objects in deployment.&quot;&quot;&quot;</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">kubernetes</span> <span class="k">import</span> <span class="n">client</span><span class="p">,</span> <span class="n">config</span>
            <span class="kn">from</span> <span class="nn">openshift.dynamic</span> <span class="k">import</span> <span class="n">DynamicClient</span>
            <span class="kn">from</span> <span class="nn">kubernetes.config.incluster_config</span> <span class="k">import</span> <span class="n">InClusterConfigLoader</span>
            <span class="kn">from</span> <span class="nn">kubernetes.client.rest</span> <span class="k">import</span> <span class="n">RESTClientObject</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to import OpenShift and Kubernetes packages. Was thoth-common library &quot;</span>
                <span class="s2">&quot;installed with openshift extras?&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;KUBERNETES_VERIFY_TLS&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="ow">and</span> <span class="n">kubernetes_verify_tls</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">in_cluster</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Try to load configuration as used in cluster. If not possible, try to load it from local configuration.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Load in-cluster configuration that is exposed by OpenShift/k8s configuration.</span>
            <span class="n">InClusterConfigLoader</span><span class="p">(</span>
                <span class="n">token_filename</span><span class="o">=</span><span class="n">_get_incluster_token_file</span><span class="p">(</span><span class="n">token_file</span><span class="p">),</span>
                <span class="n">cert_filename</span><span class="o">=</span><span class="n">_get_incluster_ca_file</span><span class="p">(</span><span class="n">cert_file</span><span class="p">),</span>
                <span class="n">environ</span><span class="o">=</span><span class="n">environ</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">load_and_set</span><span class="p">()</span>

            <span class="c1"># We need to explicitly set whether we want to verify SSL/TLS connection to the master.</span>
            <span class="n">configuration</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">Configuration</span><span class="p">()</span>
            <span class="n">configuration</span><span class="o">.</span><span class="n">verify_ssl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span> <span class="o">=</span> <span class="n">DynamicClient</span><span class="p">(</span>
                <span class="n">client</span><span class="o">.</span><span class="n">ApiClient</span><span class="p">(</span><span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Failed to load in cluster configuration, fallback to a local development setup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">k8s_client</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">new_client_from_config</span><span class="p">()</span>
            <span class="n">k8s_client</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">verify_ssl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span>
            <span class="n">k8s_client</span><span class="o">.</span><span class="n">rest_client</span> <span class="o">=</span> <span class="n">RESTClientObject</span><span class="p">(</span><span class="n">k8s_client</span><span class="o">.</span><span class="n">configuration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span> <span class="o">=</span> <span class="n">DynamicClient</span><span class="p">(</span><span class="n">k8s_client</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_cluster</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span> <span class="o">=</span> <span class="n">amun_inspection_namespace</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
            <span class="s2">&quot;THOTH_AMUN_INSPECTION_NAMESPACE&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amun_infra_namespace</span> <span class="o">=</span> <span class="n">amun_infra_namespace</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
            <span class="s2">&quot;THOTH_AMUN_INFRA_NAMESPACE&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frontend_namespace</span> <span class="o">=</span> <span class="n">frontend_namespace</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
            <span class="s2">&quot;THOTH_FRONTEND_NAMESPACE&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span> <span class="o">=</span> <span class="n">middletier_namespace</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
            <span class="s2">&quot;THOTH_MIDDLETIER_NAMESPACE&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span> <span class="o">=</span> <span class="n">backend_namespace</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
            <span class="s2">&quot;THOTH_BACKEND_NAMESPACE&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span> <span class="o">=</span> <span class="n">infra_namespace</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;THOTH_INFRA_NAMESPACE&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_api_url</span> <span class="o">=</span> <span class="n">kubernetes_api_url</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
            <span class="s2">&quot;KUBERNETES_API_URL&quot;</span><span class="p">,</span> <span class="s2">&quot;https://kubernetes.default.svc.cluster.local&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openshift_api_url</span> <span class="o">=</span> <span class="n">openshift_api_url</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
            <span class="s2">&quot;OPENSHIFT_API_URL&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">host</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;TLS verification when communicating with k8s/okd master is disabled&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access service account token mounted to the pod.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_cluster</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">get_service_account_token</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Ugly, but k8s client does not expose a nice API for this.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">auth_settings</span><span class="p">()[</span>
                    <span class="s2">&quot;BearerToken&quot;</span>
                <span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_set_env_var</span><span class="p">(</span><span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="o">**</span><span class="n">env_var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set environment in the given template.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">env_var_name</span><span class="p">,</span> <span class="n">env_var_value</span> <span class="ow">in</span> <span class="n">env_var</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;containers&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">env_var_name</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_var_value</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;containers&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;env&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">env_var_name</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">env_var_value</span><span class="p">)}</span>
                <span class="p">)</span>

<div class="viewcode-block" id="OpenShift.set_template_parameters"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.set_template_parameters">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_template_parameters</span><span class="p">(</span><span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set parameters in the template - replace existing ones or append to parameter list if not exist.</span>

<span class="sd">        &gt;&gt;&gt; set_template_parameters(template, THOTH_LOG_ADVISER=&#39;DEBUG&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Setting parameters for template </span><span class="si">%r</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">template</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">template</span><span class="p">:</span>
            <span class="n">template</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter_value</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">parameter_name</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">parameter_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">parameter_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Requested to assign parameter </span><span class="si">%r</span><span class="s2"> (value </span><span class="si">%r</span><span class="s2">) to template but template &quot;</span>
                    <span class="s2">&quot;does not provide the given parameter, forcing...&quot;</span><span class="p">,</span>
                    <span class="n">parameter_name</span><span class="p">,</span>
                    <span class="n">parameter_value</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">template</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">parameter_name</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">parameter_value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">parameter_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.get_pod_log"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_pod_log">[docs]</a>    <span class="k">def</span> <span class="nf">get_pod_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pod_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get log of a pod based on assigned pod ID.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s2">&quot;Middletier namespace is required to check log of pods run in this namespace&quot;</span>
                <span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span>

        <span class="c1"># TODO: rewrite to OpenShift rest client once it will support it.</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/api/v1/namespaces/</span><span class="si">{}</span><span class="s2">/pods/</span><span class="si">{}</span><span class="s2">/log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_api_url</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">pod_id</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">endpoint</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">),</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Kubernetes master response for pod log (</span><span class="si">%d</span><span class="s2">): </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundException</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Pod with id </span><span class="si">{pod_id}</span><span class="s2"> was not found in namespace </span><span class="si">{namespace}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
            <span class="c1"># If Pod has not been initialized yet, there is returned 400 status code. Return None in this case.</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span></div>

<div class="viewcode-block" id="OpenShift.get_build"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_build">[docs]</a>    <span class="k">def</span> <span class="nf">get_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a build in the given namespace.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: rewrite to OpenShift rest client once it will support it.</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/apis/build.openshift.io/v1/namespaces/</span><span class="si">{}</span><span class="s2">/builds/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openshift_api_url</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">build_id</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">endpoint</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">),</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundException</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Build with id </span><span class="si">{build_id}</span><span class="s2"> was not found in namespace </span><span class="si">{namespace}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift master response for build (</span><span class="si">%d</span><span class="s2">): </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenShift.get_buildconfig"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_buildconfig">[docs]</a>    <span class="k">def</span> <span class="nf">get_buildconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buildconfig_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a buildconfig in the given namespace.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: rewrite to OpenShift rest client once it will support it.</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/apis/build.openshift.io/v1/namespaces/</span><span class="si">{}</span><span class="s2">/buildconfigs/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openshift_api_url</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">buildconfig_id</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">endpoint</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">),</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundException</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;BuildConfig with id </span><span class="si">{buildconfig_id}</span><span class="s2"> was not found in namespace </span><span class="si">{namespace}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift master response for build (</span><span class="si">%d</span><span class="s2">): </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenShift.get_build_log"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_build_log">[docs]</a>    <span class="k">def</span> <span class="nf">get_build_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get log of a build in the given namespace.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: rewrite to OpenShift rest client once it will support it.</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/apis/build.openshift.io/v1/namespaces/</span><span class="si">{}</span><span class="s2">/builds/</span><span class="si">{}</span><span class="s2">/log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openshift_api_url</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">build_id</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">endpoint</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">),</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundException</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Build with id </span><span class="si">{build_id}</span><span class="s2"> was not found in namespace </span><span class="si">{namespace}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift master response for build log (</span><span class="si">%d</span><span class="s2">): </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span></div>

<div class="viewcode-block" id="OpenShift.get_pod_status"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_pod_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_pod_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pod_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get status entry for a pod - low level routine.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">openshift</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Pod&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">pod_id</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">openshift</span><span class="o">.</span><span class="n">dynamic</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotFoundError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundException</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;The given pod with id </span><span class="si">{pod_id}</span><span class="s2"> could not be found&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpenShift master response for pod status: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;containerStatuses&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]:</span>
            <span class="c1"># No status - pod is being scheduled.</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">][</span><span class="s2">&quot;containerStatuses&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
        <span class="c1"># Translate kills of liveness probes to our messages reported to user.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;terminated&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exitCode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">137</span>
            <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;terminated&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Error&quot;</span>
        <span class="p">):</span>
            <span class="c1"># Reason can be set by OpenShift to be OOMKilled for example - we expect only &quot;Error&quot; to be set to</span>
            <span class="c1"># treat this as timeout.</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;terminated&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TimeoutKilled&quot;</span>

        <span class="k">return</span> <span class="n">state</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_status_report</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct status response for API response from master API response.&quot;&quot;&quot;</span>
        <span class="n">_TRANSLATION_TABLE</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;exitCode&quot;</span><span class="p">:</span> <span class="s2">&quot;exit_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;finishedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;finished_at&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;reason&quot;</span><span class="p">,</span>
            <span class="s2">&quot;startedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;started_at&quot;</span><span class="p">,</span>
            <span class="s2">&quot;containerID&quot;</span><span class="p">:</span> <span class="s2">&quot;container&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;reason&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If pod was not initialized yet and user asks for status, return default values with state scheduling.</span>
            <span class="n">reported_status</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_TRANSLATION_TABLE</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">reported_status</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;scheduling&quot;</span>
            <span class="k">return</span> <span class="n">reported_status</span>

        <span class="n">state</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">reported_status</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_TRANSLATION_TABLE</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">reported_status</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">status</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;containerID&quot;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">value</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;docker://&quot;</span><span class="p">):]</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;docker://&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">value</span>
                <span class="p">)</span>
                <span class="n">reported_status</span><span class="p">[</span><span class="s2">&quot;container&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reported_status</span><span class="p">[</span><span class="n">_TRANSLATION_TABLE</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">reported_status</span>

<div class="viewcode-block" id="OpenShift.get_pod_status_report"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_pod_status_report">[docs]</a>    <span class="k">def</span> <span class="nf">get_pod_status_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pod_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get pod state and convert it to a user-friendly response.&quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pod_status</span><span class="p">(</span><span class="n">pod_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_report</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_pod_id_from_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get pod name from a job.&quot;&quot;&quot;</span>
        <span class="c1"># Kubernetes automatically adds &#39;job-name&#39; label -&gt; reuse it.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Pod&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">,</span>
            <span class="n">label_selector</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;job-name=</span><span class="si">{job_id}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpenShift response for pod id from job: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Log this error and report back to user not found.</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;Multiple pods for the same job name selector </span><span class="si">{job_id}</span><span class="s2"> found&quot;</span>
                <span class="p">)</span>

            <span class="k">raise</span> <span class="n">NotFoundException</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Job with the given id </span><span class="si">{job_id}</span><span class="s2"> was not found&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="OpenShift.get_configmap"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_configmap">[docs]</a>    <span class="k">def</span> <span class="nf">get_configmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configmap_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the given configmap in a namespace, return object representing config map.&quot;&quot;&quot;</span>
        <span class="n">v1_configmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;ConfigMap&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v1_configmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">configmap_id</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.get_job_status_report"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_job_status_report">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_status_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get status of a pod running inside a job.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pod_id_from_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try to retrieve configmap - if we are successful it means we have registered the given</span>
                <span class="c1"># job (workload), but it was queued due to resources not being available. This code will go away</span>
                <span class="c1"># once we introduce a proper workflow management.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_configmap</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;exit_code&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;finished_at&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;WorkloadRegistered&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;started_at&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;registered&quot;</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Raise the original exception as the given pod was not found based on job id.</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pod_status_report</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.get_job_log"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_job_log">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get log of a pod running inside a job.&quot;&quot;&quot;</span>
        <span class="n">pod_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pod_id_from_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pod_log</span><span class="p">(</span><span class="n">pod_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.get_jobs"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all Jobs, select them by the provided label.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">openshift</span>

        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;batch/v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;JobList&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span> <span class="n">label_selector</span><span class="o">=</span><span class="n">label_selector</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">openshift</span><span class="o">.</span><span class="n">dynamic</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotFoundError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundException</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;No Jobs with label </span><span class="si">{label_selector}</span><span class="s2"> could be found&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpenShift response: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="OpenShift.create_inspection_imagestream"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.create_inspection_imagestream">[docs]</a>    <span class="k">def</span> <span class="nf">create_inspection_imagestream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inspection_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create imagestream for Amun.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">amun_infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Amun infra namespace is required in order to create Amun inspect imagestreams&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to create inspection image stream without Amun inspection namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_infra_namespace</span><span class="p">,</span>
            <span class="n">label_selector</span><span class="o">=</span><span class="s2">&quot;template=amun-inspect-imagestream&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for getting Amun inspect ImageStream template: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">AMUN_INSPECTION_ID</span><span class="o">=</span><span class="n">inspection_id</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_infra_namespace</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">imagestream</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">imagestream</span><span class="p">[</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">imagestream</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">imagestream</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpenShift response for creating Amun ImageStream: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="OpenShift.schedule_inspection_build"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_inspection_build">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_inspection_build</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">inspection_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_hw_template</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule inspection build.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to schedule inspection build without Amun inspection namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_workload</span><span class="p">(</span>
            <span class="n">run_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_inspection_build</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">template_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_inspection_build_template</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">template_method_parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;use_hw_template&quot;</span><span class="p">:</span> <span class="n">use_hw_template</span><span class="p">},</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;amun-inspection-build&quot;</span><span class="p">,</span> <span class="s2">&quot;inspection&quot;</span><span class="p">:</span> <span class="n">inspection_id</span><span class="p">},</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">inspection_id</span> <span class="o">+</span> <span class="s1">&#39;-build&#39;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.get_inspection_build_template"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_inspection_build_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_inspection_build_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_hw_template</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get inspection buildconfig that should be run.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">amun_infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Infra namespace is required in order to create inspect imagestreams&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to create inspection buildconfig without Amun inspection namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_hw_template</span><span class="p">:</span>
            <span class="n">label_selector</span> <span class="o">=</span> <span class="s2">&quot;template=amun-inspect-buildconfig-with-cpu&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_selector</span> <span class="o">=</span> <span class="s2">&quot;template=amun-inspect-buildconfig&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_infra_namespace</span><span class="p">,</span> <span class="n">label_selector</span><span class="o">=</span><span class="n">label_selector</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for getting Amun inspect BuildConfig template: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span></div>

<div class="viewcode-block" id="OpenShift.run_inspection_build"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.run_inspection_build">[docs]</a>    <span class="k">def</span> <span class="nf">run_inspection_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the inspection build.&quot;&quot;&quot;</span>
        <span class="n">buildconfig</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">buildconfig</span><span class="p">[</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">buildconfig</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">buildconfig</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for creating Amun BuildConfig: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="OpenShift.schedule_inspection_job"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_inspection_job">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_inspection_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inspection_id</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">use_hw_template</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">cpu_requests</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">memory_requests</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule the given job run, the scheduled job is handled by workload operator based resources available.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to schedule inspection job without Amun inspection namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;inspection_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_workload</span><span class="p">(</span>
            <span class="n">run_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_inspection_job</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">run_method_parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">template_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_inspection_job_template</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">template_method_parameters</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;use_hw_template&quot;</span><span class="p">:</span> <span class="n">use_hw_template</span><span class="p">,</span>
                <span class="s2">&quot;cpu_requests&quot;</span><span class="p">:</span> <span class="n">cpu_requests</span><span class="p">,</span>
                <span class="s2">&quot;memory_requests&quot;</span><span class="p">:</span> <span class="n">memory_requests</span>
            <span class="p">},</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">inspection_id</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;amun-inspection&quot;</span><span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.run_inspection_job"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.run_inspection_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_inspection_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">use_hw_template</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">cpu_requests</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">memory_requests</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the actual inspect job.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">amun_infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Amun infra namespace is required in order to create inspection job&quot;</span>
            <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inspection_job_template</span><span class="p">(</span>
            <span class="n">use_hw_template</span><span class="o">=</span><span class="n">use_hw_template</span><span class="p">,</span>
            <span class="n">cpu_requests</span><span class="o">=</span><span class="n">cpu_requests</span><span class="p">,</span>
            <span class="n">memory_requests</span><span class="o">=</span><span class="n">memory_requests</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for creating Amun Job: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="OpenShift.get_inspection_job_template"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_inspection_job_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_inspection_job_template</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">use_hw_template</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">cpu_requests</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">memory_requests</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get template for an inspection job.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">amun_inspection_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to create inspection job without Amun inspection namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_hw_template</span><span class="p">:</span>
            <span class="n">label_selector</span> <span class="o">=</span> <span class="s2">&quot;template=amun-inspect-job-with-cpu&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_selector</span> <span class="o">=</span> <span class="s2">&quot;template=amun-inspect-job&quot;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amun_infra_namespace</span><span class="p">,</span> <span class="n">label_selector</span><span class="o">=</span><span class="n">label_selector</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for getting Amun inspect Job template: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span>
        <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># We explicitly set template CPU and memory here so that we can schedule based</span>
        <span class="c1"># on resources needed in the workload-operator. We cannot do this as a partial oc process,</span>
        <span class="c1"># so we explicitly modify template here (other parameters are about to be expanded later).</span>
        <span class="n">container_spec</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;template&quot;</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;containers&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cpu_requests</span><span class="p">:</span>
            <span class="n">container_spec</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">][</span><span class="s2">&quot;limits&quot;</span><span class="p">][</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_requests</span>
            <span class="n">container_spec</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">][</span><span class="s2">&quot;requests&quot;</span><span class="p">][</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_requests</span>

        <span class="k">if</span> <span class="n">memory_requests</span><span class="p">:</span>
            <span class="n">container_spec</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">][</span><span class="s2">&quot;limits&quot;</span><span class="p">][</span><span class="s2">&quot;memory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory_requests</span>
            <span class="n">container_spec</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">][</span><span class="s2">&quot;requests&quot;</span><span class="p">][</span><span class="s2">&quot;memory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">memory_requests</span>

        <span class="k">return</span> <span class="n">template</span></div>

<div class="viewcode-block" id="OpenShift.get_solver_names"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_solver_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_solver_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve name of solvers available in installation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Infra namespace is required in order to list solvers&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">,</span> <span class="n">label_selector</span><span class="o">=</span><span class="s2">&quot;template=solver&quot;</span>
        <span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for getting solver template: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="s2">&quot;component&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="OpenShift.schedule_all_solvers"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_all_solvers">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_all_solvers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">packages</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">indexes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">subgraph_check_api</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Schedule all solvers for the given packages.&quot;&quot;&quot;</span>
        <span class="n">solver_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">solver_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solver_names</span><span class="p">():</span>
            <span class="n">solver_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_solver</span><span class="p">(</span>
                <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
                <span class="n">solver</span><span class="o">=</span><span class="n">solver_name</span><span class="p">,</span>
                <span class="n">indexes</span><span class="o">=</span><span class="n">indexes</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
                <span class="n">subgraph_check_api</span><span class="o">=</span><span class="n">subgraph_check_api</span><span class="p">,</span>
                <span class="n">transitive</span><span class="o">=</span><span class="n">transitive</span>
            <span class="p">)</span>

            <span class="n">solver_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solver_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">solver_ids</span></div>

<div class="viewcode-block" id="OpenShift.run_solver"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.run_solver">[docs]</a>    <span class="k">def</span> <span class="nf">run_solver</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">packages</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">indexes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">subgraph_check_api</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run solver or all solver to solve the given requirements.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">:</span>
            <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Solver requires middletier namespace to be specified&quot;</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solver_template</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span>
            <span class="n">template</span><span class="p">,</span>
            <span class="n">THOTH_SOLVER_NO_TRANSITIVE</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">transitive</span><span class="p">),</span>
            <span class="n">THOTH_SOLVER_PACKAGES</span><span class="o">=</span><span class="n">packages</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">),</span>
            <span class="n">THOTH_SOLVER_INDEXES</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span> <span class="k">if</span> <span class="n">indexes</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">THOTH_LOG_SOLVER</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
            <span class="n">THOTH_SOLVER_OUTPUT</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
            <span class="n">THOTH_SOLVER_JOB_ID</span><span class="o">=</span><span class="n">job_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="n">solver</span><span class="p">),</span>
            <span class="n">THOTH_SOLVER_SUBGRAPH_CHECK_API</span><span class="o">=</span><span class="n">subgraph_check_api</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">solver_template</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">solver_template</span><span class="p">[</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">solver_template</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">solver_template</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting solver </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">solver</span><span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpenShift response for creating a pod: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="OpenShift.schedule_solver"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_solver">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_solver</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">packages</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">indexes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">subgraph_check_api</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule the given solver.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to schedule solver job without middletier namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_workload</span><span class="p">(</span>
            <span class="n">run_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_solver</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">run_method_parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">template_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_solver_template</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">template_method_parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;solver&quot;</span><span class="p">:</span> <span class="n">solver</span><span class="p">},</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;solver&quot;</span><span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.get_solver_template"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_solver_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_solver_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a solver template.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Infra namespace is required to gather solver template when running solver&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">,</span>
            <span class="n">label_selector</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;template=solver,component=</span><span class="si">{solver}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for getting solver template: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">template</span></div>

<div class="viewcode-block" id="OpenShift.schedule_package_extract"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_package_extract">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_package_extract</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">environment_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">registry_user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">registry_password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify_tls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule the given job run, the scheduled job is handled by workload operator based resources available.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to schedule package extract job without backend namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">environment_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;runtime&#39;</span><span class="p">,</span> <span class="s1">&#39;buildtime&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown environment type </span><span class="si">%r</span><span class="s2">, has to be runtime or buildtime&quot;</span><span class="p">)</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="s2">&quot;package-extract&quot;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_workload</span><span class="p">(</span>
            <span class="n">run_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_package_extract</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">run_method_parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">template_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_package_extract_template</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;package-extract&quot;</span><span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.run_package_extract"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.run_package_extract">[docs]</a>    <span class="k">def</span> <span class="nf">run_package_extract</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">environment_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">registry_user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">registry_password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify_tls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run package-extract analyzer to extract information from the provided image.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Running package-extract requires middletier namespace to be specified&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">environment_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;runtime&#39;</span><span class="p">,</span> <span class="s1">&#39;buildtime&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown environment type </span><span class="si">%r</span><span class="s2">, has to be runtime or buildtime&quot;</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_package_extract_template</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span>
            <span class="n">template</span><span class="p">,</span>
            <span class="n">THOTH_LOG_PACKAGE_EXTRACT</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
            <span class="n">THOTH_ANALYZED_IMAGE</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
            <span class="n">THOTH_ANALYZER_NO_TLS_VERIFY</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">verify_tls</span><span class="p">),</span>
            <span class="n">THOTH_ANALYZER_OUTPUT</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
            <span class="n">THOTH_PACKAGE_EXTRACT_JOB_ID</span><span class="o">=</span><span class="n">job_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="s2">&quot;package-extract&quot;</span><span class="p">),</span>
            <span class="n">THOTH_PACKAGE_EXTRACT_METADATA</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">origin</span><span class="p">,</span>
                <span class="s2">&quot;environment_type&quot;</span><span class="p">:</span> <span class="n">environment_type</span><span class="p">,</span>
            <span class="p">}),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">registry_user</span> <span class="ow">and</span> <span class="n">registry_password</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span>
                <span class="n">template</span><span class="p">,</span>
                <span class="n">THOTH_REGISTRY_CREDENTIALS</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{registry_user}</span><span class="s2">:</span><span class="si">{registry_password}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">analyzer</span><span class="p">[</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">analyzer</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">analyzer</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpenShift response for creating a pod: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="OpenShift.get_package_extract_template"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_package_extract_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_package_extract_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get template for package-extract.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Infra namespace is required to gather package-extract template when running it&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">,</span> <span class="n">label_selector</span><span class="o">=</span><span class="s2">&quot;template=package-extract&quot;</span>
        <span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for getting package-extract template: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">template</span></div>

<div class="viewcode-block" id="OpenShift.create_config_map"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.create_config_map">[docs]</a>    <span class="k">def</span> <span class="nf">create_config_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">configmap_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a ConfigMap in the given namespace.&quot;&quot;&quot;</span>
        <span class="n">v1_configmaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;ConfigMap&quot;</span>
        <span class="p">)</span>
        <span class="n">v1_configmaps</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">body</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;apiVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;v1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;ConfigMap&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">configmap_name</span><span class="p">,</span>
                    <span class="s2">&quot;namespace&quot;</span><span class="p">:</span> <span class="n">namespace</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">configmap_name</span></div>

    <span class="k">def</span> <span class="nf">_schedule_workload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">run_method_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">template_method_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">run_method_parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template_method_parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule the given job run, the scheduled job is handled by workload operator based resources available.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="c1"># Inject labels needed by default.</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_WORKLOAD_LABELS</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_config_map</span><span class="p">(</span>
            <span class="n">job_id</span><span class="p">,</span>
            <span class="n">namespace</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_WORKLOAD_LABELS</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;run_method_name&quot;</span><span class="p">:</span> <span class="n">run_method_name</span><span class="p">,</span>
                <span class="s2">&quot;run_method_parameters&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">run_method_parameters</span> <span class="ow">or</span> <span class="p">{}),</span>
                <span class="s2">&quot;template_method_name&quot;</span><span class="p">:</span> <span class="n">template_method_name</span><span class="p">,</span>
                <span class="s2">&quot;template_method_parameters&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="n">template_method_parameters</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">job_id</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_id</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate an identifier.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;-</span><span class="si">%016x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>

<div class="viewcode-block" id="OpenShift.schedule_dependency_monkey"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_dependency_monkey">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_dependency_monkey</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">requirements</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
        <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">stack_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">report_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">decision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_latest_versions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule a dependency monkey run.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to schedule dependency monkey without middletier namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="s2">&quot;dependency-monkey&quot;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_workload</span><span class="p">(</span>
            <span class="n">run_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dependency_monkey</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">run_method_parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">template_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dependency_monkey_template</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;dependency-monkey&quot;</span><span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.run_dependency_monkey"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.run_dependency_monkey">[docs]</a>    <span class="k">def</span> <span class="nf">run_dependency_monkey</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">requirements</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
        <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">stack_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">report_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">decision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_latest_versions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run Dependency Monkey on the provided user input.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Running Dependency Monkey requires middletier namespace configuration&quot;</span>
            <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dependency_monkey_template</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">requirements</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># There was passed a serialized Pipfile into dict, serialize it into JSON.</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;THOTH_ADVISER_REQUIREMENTS&quot;</span><span class="p">:</span> <span class="n">requirements</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">),</span>
            <span class="s2">&quot;THOTH_AMUN_CONTEXT&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">),</span>
            <span class="s2">&quot;THOTH_DEPENDENCY_MONKEY_STACK_OUTPUT&quot;</span><span class="p">:</span> <span class="n">stack_output</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;THOTH_DEPENDENCY_MONKEY_REPORT_OUTPUT&quot;</span><span class="p">:</span> <span class="n">report_output</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="s2">&quot;THOTH_DEPENDENCY_MONKEY_DRY_RUN&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">dry_run</span><span class="p">)),</span>
            <span class="s2">&quot;THOTH_LOG_ADVISER&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
            <span class="s2">&quot;THOTH_DEPENDENCY_MONKEY_JOB_ID&quot;</span><span class="p">:</span> <span class="n">job_id</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="s2">&quot;dependency-monkey&quot;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">decision</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;THOTH_DEPENDENCY_MONKEY_DECISION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decision</span>

        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;THOTH_DEPENDENCY_MONKEY_SEED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed</span>

        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;THOTH_DEPENDENCY_MONKEY_COUNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

        <span class="k">if</span> <span class="n">limit_latest_versions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;THOTH_ADVISER_LIMIT_LATEST_VERSIONS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit_latest_versions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">dependency_monkey</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">dependency_monkey</span><span class="p">[</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">dependency_monkey</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">dependency_monkey</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middletier_namespace</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpenShift response for creating a pod: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="OpenShift.get_dependency_monkey_template"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_dependency_monkey_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_dependency_monkey_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get template for a dependency monkey.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Infra namespace is required to gather Dependency Monkey template when running it&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">,</span> <span class="n">label_selector</span><span class="o">=</span><span class="s2">&quot;template=dependency-monkey&quot;</span>
        <span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for getting dependency-monkey template: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">template</span></div>

<div class="viewcode-block" id="OpenShift.schedule_adviser"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_adviser">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_adviser</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">application_stack</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">recommendation_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">runtime_environment</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_latest_versions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule an adviser run.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to schedule adviser without backend namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="s2">&quot;adviser&quot;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_workload</span><span class="p">(</span>
            <span class="n">run_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_adviser</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">run_method_parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">template_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_adviser_template</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;adviser&quot;</span><span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.run_adviser"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.run_adviser">[docs]</a>    <span class="k">def</span> <span class="nf">run_adviser</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">application_stack</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">recommendation_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">runtime_environment</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_latest_versions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run adviser on the provided user input.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Running adviser requires backend namespace configuration&quot;</span>
            <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adviser_template</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">runtime_environment</span><span class="p">:</span>
            <span class="n">runtime_environment</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">runtime_environment</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;THOTH_ADVISER_REQUIREMENTS&quot;</span><span class="p">:</span> <span class="n">application_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;requirements&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;THOTH_ADVISER_REQUIREMENTS_LOCKED&quot;</span><span class="p">:</span> <span class="n">application_stack</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;requirements_lock&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">),</span>
            <span class="s2">&quot;THOTH_ADVISER_REQUIREMENTS_FORMAT&quot;</span><span class="p">:</span> <span class="n">application_stack</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;requirements_formant&quot;</span><span class="p">,</span> <span class="s2">&quot;pipenv&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;THOTH_ADVISER_RECOMMENDATION_TYPE&quot;</span><span class="p">:</span> <span class="n">recommendation_type</span><span class="p">,</span>
            <span class="s2">&quot;THOTH_ADVISER_RUNTIME_ENVIRONMENT&quot;</span><span class="p">:</span> <span class="n">runtime_environment</span><span class="p">,</span>
            <span class="s2">&quot;THOTH_ADVISER_METADATA&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">origin</span><span class="p">}),</span>
            <span class="s2">&quot;THOTH_ADVISER_OUTPUT&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
            <span class="s2">&quot;THOTH_LOG_ADVISER&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
            <span class="s2">&quot;THOTH_ADVISER_JOB_ID&quot;</span><span class="p">:</span> <span class="n">job_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="s2">&quot;adviser&quot;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;THOTH_ADVISER_COUNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;THOTH_ADVISER_LIMIT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>

        <span class="k">if</span> <span class="n">limit_latest_versions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;THOTH_ADVISER_LIMIT_LATEST_VERSIONS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit_latest_versions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">adviser</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">adviser</span><span class="p">[</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">adviser</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">adviser</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpenShift response for creating a pod: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="OpenShift.get_adviser_template"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_adviser_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_adviser_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get template for an adviser run.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Infra namespace is required to gather adviser template when running it&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">,</span> <span class="n">label_selector</span><span class="o">=</span><span class="s2">&quot;template=adviser&quot;</span>
        <span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for getting adviser template: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">template</span></div>

<div class="viewcode-block" id="OpenShift.schedule_provenance_checker"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_provenance_checker">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_provenance_checker</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">application_stack</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">whitelisted_sources</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule a provenance checker run.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to schedule provenance checker without backend namespace being set&quot;</span>
            <span class="p">)</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="s2">&quot;provenance-checker&quot;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_workload</span><span class="p">(</span>
            <span class="n">run_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_provenance_checker</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">run_method_parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">template_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_provenance_checker_template</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;provenance-checker&quot;</span><span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.run_provenance_checker"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.run_provenance_checker">[docs]</a>    <span class="k">def</span> <span class="nf">run_provenance_checker</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">application_stack</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">whitelisted_sources</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run provenance checks on the provided user input.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Running provenance checks requires backend namespace configuration&quot;</span>
            <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_provenance_checker_template</span><span class="p">()</span>

        <span class="n">requirements</span> <span class="o">=</span> <span class="n">application_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;requirements&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span>
        <span class="n">requirements_locked</span> <span class="o">=</span> <span class="n">application_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;requirements_lock&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span>
        <span class="p">)</span>
        <span class="n">whitelisted_sources</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">whitelisted_sources</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span>
            <span class="n">template</span><span class="p">,</span>
            <span class="n">THOTH_ADVISER_REQUIREMENTS</span><span class="o">=</span><span class="n">requirements</span><span class="p">,</span>
            <span class="n">THOTH_ADVISER_REQUIREMENTS_LOCKED</span><span class="o">=</span><span class="n">requirements_locked</span><span class="p">,</span>
            <span class="n">THOTH_ADVISER_OUTPUT</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
            <span class="n">THOTH_ADVISER_METADATA</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">origin</span><span class="p">}),</span>
            <span class="n">THOTH_WHITELISTED_SOURCES</span><span class="o">=</span><span class="n">whitelisted_sources</span><span class="p">,</span>
            <span class="n">THOTH_LOG_ADVISER</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
            <span class="n">THOTH_PROVENANCE_CHECKER_JOB_ID</span><span class="o">=</span><span class="n">job_id</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="s2">&quot;provenance-checker&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">provenance_checker</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">provenance_checker</span><span class="p">[</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">],</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">provenance_checker</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">provenance_checker</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_namespace</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpenShift response for creating a pod: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="OpenShift.get_provenance_checker_template"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_provenance_checker_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_provenance_checker_template</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get template for a provenance checker.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Infra namespace is required to gather provenance template when running it&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">,</span> <span class="n">label_selector</span><span class="o">=</span><span class="s2">&quot;template=provenance-checker&quot;</span>
        <span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift response for getting provenance-checker template: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">template</span></div>

<div class="viewcode-block" id="OpenShift.schedule_graph_sync"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_graph_sync">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_graph_sync</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Schedule a graph sync.&quot;&quot;&quot;</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="s2">&quot;graph-sync-&quot;</span> <span class="o">+</span> <span class="n">document_id</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_workload</span><span class="p">(</span>
            <span class="n">run_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_graph_sync</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">run_method_parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">template_method_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_graph_sync_template</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">template_method_parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;template_name&quot;</span><span class="p">:</span> <span class="n">template_name</span><span class="p">},</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;graph-sync&quot;</span><span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.schedule_graph_sync_adviser"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_graph_sync_adviser">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_graph_sync_adviser</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule a sync of an adviser document - a sugar for user.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_graph_sync</span><span class="p">(</span><span class="n">document_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="s2">&quot;graph-sync-job-adviser&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.schedule_graph_sync_inspection"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_graph_sync_inspection">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_graph_sync_inspection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule a sync of inspection - a sugar for user.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_graph_sync</span><span class="p">(</span><span class="n">document_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="s2">&quot;graph-sync-job-inspection&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.schedule_graph_sync_solver"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_graph_sync_solver">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_graph_sync_solver</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule a sync of solver result - a sugar for user.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_graph_sync</span><span class="p">(</span><span class="n">document_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="s2">&quot;graph-sync-job-solver&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.schedule_graph_sync_package_extract"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.schedule_graph_sync_package_extract">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_graph_sync_package_extract</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule a sync of package-extract - a sugar for user.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule_graph_sync</span><span class="p">(</span><span class="n">document_id</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="s2">&quot;graph-sync-job-package-extract&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.run_graph_sync"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.run_graph_sync">[docs]</a>    <span class="k">def</span> <span class="nf">run_graph_sync</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the given graph sync.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to run graph sync without namespace being specified&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">template</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">template_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;At least one of `template` and `template_name` should be specified&quot;</span>
            <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graph_sync_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_template_parameters</span><span class="p">(</span>
            <span class="n">template</span><span class="p">,</span>
            <span class="n">THOTH_SYNC_DOCUMENT_ID</span><span class="o">=</span><span class="n">document_id</span><span class="p">,</span>
            <span class="n">THOTH_JOB_ID</span><span class="o">=</span><span class="n">job_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc_process</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">graph_sync</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">graph_sync</span><span class="p">[</span><span class="s2">&quot;apiVersion&quot;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">graph_sync</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">graph_sync</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Scheduled new sync with id </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="OpenShift.get_graph_sync_template"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_graph_sync_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph_sync_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get graph sync template.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s2">&quot;Infra namespace is required in order to gather graph sync template&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">template_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to get graph sync template without template name being specified&quot;</span>
            <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ocp_client</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;Template&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">infra_namespace</span><span class="p">,</span>
            <span class="n">label_selector</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;component=graph-sync,template=</span><span class="si">{template_name}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_invalid_response_size</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">template</span></div>

    <span class="k">def</span> <span class="nf">_raise_on_invalid_response_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;It is expected that there is only one object type for the given item.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Application misconfiguration - number of templates available in the infra namespace &quot;</span>
                <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.infra_namespace!r}</span><span class="s2"> is {len(response.items)}, should be 1.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="OpenShift.oc_process"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.oc_process">[docs]</a>    <span class="k">def</span> <span class="nf">oc_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process the given template in OpenShift.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: This does not work - see issue reported upstream:</span>
        <span class="c1">#   https://github.com/openshift/openshift-restclient-python/issues/190</span>
        <span class="c1"># return TemplateOpenshiftIoApi().create_namespaced_processed_template_v1(namespace, template)</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/apis/template.openshift.io/v1/namespaces/</span><span class="si">{}</span><span class="s2">/processedtemplates&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openshift_api_url</span><span class="p">,</span> <span class="n">namespace</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">endpoint</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">),</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift master response template (</span><span class="si">%d</span><span class="s2">): </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to process template: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenShift.parse_cpu_spec"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.parse_cpu_spec">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_cpu_spec</span><span class="p">(</span><span class="n">cpu_spec</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Parse the given CPU requirement as used by OpenShift/Kubernetes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cpu_spec</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cpu_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">):</span>
                <span class="n">cpu_spec</span> <span class="o">=</span> <span class="n">cpu_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cpu_spec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>

        <span class="k">if</span> <span class="n">cpu_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">cpu_spec</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenShift.parse_memory_spec"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.parse_memory_spec">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_memory_spec</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Parse the given CPU requirement as used by OpenShift/Kubernetes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">memory_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">**</span> <span class="mi">6</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">**</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">**</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Ei&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">6</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Pi&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Ti&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Gi&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Mi&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">memory_spec</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Ki&quot;</span><span class="p">):</span>
            <span class="n">memory_spec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memory_spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">memory_spec</span> <span class="o">*</span> <span class="mi">1024</span></div>

<div class="viewcode-block" id="OpenShift.get_quota_status"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.get_quota_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_quota_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get quota status.</span>

<span class="sd">        For now, there is retrieved a very first quota specification and its status from resource quota list, we</span>
<span class="sd">        gather information about memory, CPU usage and number of pods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: rewrite to OpenShift REST client</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/api/v1/namespaces/</span><span class="si">{}</span><span class="s2">/resourcequotas&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openshift_api_url</span><span class="p">,</span> <span class="n">namespace</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">endpoint</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">),</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kubernetes_verify_tls</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;OpenShift master response for quota (</span><span class="si">%d</span><span class="s2">): </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to obtain quota: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># We get a very first item for now.</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
        <span class="n">pods_used</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;used&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pods&quot;</span><span class="p">)</span>
        <span class="n">pods_hard</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;hard&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pods&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;used&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cpu_spec</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;used&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits.cpu&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;memory&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_memory_spec</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;used&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits.memory&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;pods&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">pods_used</span><span class="p">)</span> <span class="k">if</span> <span class="n">pods_used</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;hard&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cpu_spec</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;hard&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits.cpu&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;memory&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_memory_spec</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;hard&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limits.memory&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;pods&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">pods_hard</span><span class="p">)</span> <span class="k">if</span> <span class="n">pods_hard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="OpenShift.can_run_workload"><a class="viewcode-back" href="../../../thoth.common.html#thoth.common.openshift.OpenShift.can_run_workload">[docs]</a>    <span class="k">def</span> <span class="nf">can_run_workload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given (job) can be run in the given namespace based on mem, cpu and pod restrictions.&quot;&quot;&quot;</span>
        <span class="n">quota_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quota_status</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">quota_status</span><span class="p">[</span><span class="s2">&quot;hard&quot;</span><span class="p">][</span><span class="s2">&quot;pods&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">quota_status</span><span class="p">[</span><span class="s2">&quot;used&quot;</span><span class="p">][</span><span class="s2">&quot;pods&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">quota_status</span><span class="p">[</span><span class="s2">&quot;hard&quot;</span><span class="p">][</span><span class="s2">&quot;pods&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot run workload, no pods available&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">template_name</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Job&quot;</span><span class="p">:</span>
            <span class="n">cpu_requested</span><span class="p">,</span> <span class="n">mem_requested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_job_requests</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;BuildConfig&quot;</span><span class="p">:</span>
            <span class="n">cpu_requested</span><span class="p">,</span> <span class="n">mem_requested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_build_requests</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Unable to handle template </span><span class="si">{template_name}</span><span class="s2"> - no requests gathering method defined for &quot;</span>
                <span class="n">f</span><span class="s2">&quot;workload of type </span><span class="si">{template[&#39;objects&#39;][0][&#39;kind&#39;]}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">quota_status</span><span class="p">[</span><span class="s2">&quot;used&quot;</span><span class="p">][</span><span class="s2">&quot;memory&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mem_requested</span>
            <span class="o">&gt;</span> <span class="n">quota_status</span><span class="p">[</span><span class="s2">&quot;hard&quot;</span><span class="p">][</span><span class="s2">&quot;memory&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot run workload </span><span class="si">%r</span><span class="s2">, no memory available&quot;</span><span class="p">,</span> <span class="n">template_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">quota_status</span><span class="p">[</span><span class="s2">&quot;used&quot;</span><span class="p">][</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cpu_requested</span>
            <span class="o">&gt;</span> <span class="n">quota_status</span><span class="p">[</span><span class="s2">&quot;hard&quot;</span><span class="p">][</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot run workload </span><span class="si">%r</span><span class="s2">, no CPU available&quot;</span><span class="p">,</span> <span class="n">template_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_get_job_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get resources needed for running a workload of type Job.&quot;&quot;&quot;</span>
        <span class="n">template_name</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Template </span><span class="si">%r</span><span class="s2"> has multiple pods defined, only the first will be considered in workload computation&quot;</span><span class="p">,</span>
                <span class="n">template_name</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">pod_mem_requested</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pod_cpu_requested</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span><span class="s2">&quot;template&quot;</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">][</span>
            <span class="s2">&quot;containers&quot;</span>
        <span class="p">]:</span>
            <span class="n">container_mem_requested</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">container_mem_requested</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No memory requests for container </span><span class="si">%r</span><span class="s2"> in template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">container</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="n">template_name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">container_mem_requested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_memory_spec</span><span class="p">(</span><span class="n">container_mem_requested</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">container_mem_requested</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pod_mem_requested</span> <span class="o">+=</span> <span class="n">container_mem_requested</span>

            <span class="n">container_cpu_requested</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">container_cpu_requested</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No CPU requests for container </span><span class="si">%r</span><span class="s2"> in template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">container</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="n">template_name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">container_cpu_requested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cpu_spec</span><span class="p">(</span><span class="n">container_cpu_requested</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">container_cpu_requested</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pod_cpu_requested</span> <span class="o">+=</span> <span class="n">container_cpu_requested</span>

        <span class="k">return</span> <span class="n">pod_cpu_requested</span><span class="p">,</span> <span class="n">pod_mem_requested</span>

    <span class="k">def</span> <span class="nf">_get_build_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get resources needed for running a workload of type BuildConfig (running the build).&quot;&quot;&quot;</span>
        <span class="n">template_name</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Template </span><span class="si">%r</span><span class="s2"> has multiple objects defined, only the first will be considered in workload computation&quot;</span><span class="p">,</span>
                <span class="n">template_name</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">build_memory</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">build_memory</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No memory requests for build in template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">template_name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">build_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_memory_spec</span><span class="p">(</span><span class="n">build_memory</span><span class="p">)</span>

        <span class="n">build_cpu</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">build_cpu</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No CPU requests for build in template </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">template_name</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">build_cpu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cpu_spec</span><span class="p">(</span><span class="n">build_cpu</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">build_cpu</span><span class="p">,</span> <span class="n">build_memory</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Thoth team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>