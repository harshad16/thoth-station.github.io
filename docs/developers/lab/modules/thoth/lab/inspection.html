
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>thoth.lab.inspection &#8212; Thoth lab 0.2.6 documentation</title>
    <link rel="stylesheet" href="/assets/nameko.css" type="text/css" />
    <link rel="stylesheet" href="/assets/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="/assets/documentation_options.js"></script>
    <script type="text/javascript" src="/assets/jquery.js"></script>
    <script type="text/javascript" src="/assets/underscore.js"></script>
    <script type="text/javascript" src="/assets/doctools.js"></script>
    <script type="text/javascript" src="/assets/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Lora:400' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Thoth lab 0.2.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thoth.lab.inspection</h1><div class="highlight"><pre>
<span></span><span class="c1"># thoth-lab</span>
<span class="c1"># Copyright(C) 2018, 2019, 2020 Marek Cermak, Francesco Murdaca</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and / or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Inspection results processing and analysis.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">typing</span>

<span class="kn">import</span> <span class="nn">cufflinks</span> <span class="k">as</span> <span class="nn">cf</span>
<span class="kn">import</span> <span class="nn">plotly</span>
<span class="kn">import</span> <span class="nn">plotly.offline</span> <span class="k">as</span> <span class="nn">py</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">pandas_profiling</span> <span class="kn">import</span> <span class="n">ProfileReport</span> <span class="k">as</span> <span class="n">profile</span>
<span class="kn">from</span> <span class="nn">prettyprinter</span> <span class="kn">import</span> <span class="n">pformat</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span>

<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">plotly</span> <span class="kn">import</span> <span class="n">graph_objs</span> <span class="k">as</span> <span class="n">go</span>
<span class="kn">from</span> <span class="nn">plotly</span> <span class="kn">import</span> <span class="n">figure_factory</span> <span class="k">as</span> <span class="n">ff</span>
<span class="kn">from</span> <span class="nn">plotly</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">plotly.offline</span> <span class="kn">import</span> <span class="n">download_plotlyjs</span><span class="p">,</span> <span class="n">init_notebook_mode</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">iplot</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>

<span class="kn">from</span> <span class="nn">thoth.storages</span> <span class="kn">import</span> <span class="n">InspectionResultsStore</span>
<span class="kn">from</span> <span class="nn">thoth.lab.utils</span> <span class="kn">import</span> <span class="n">group_index</span>
<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">aggregate_thoth_results</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;thoth.lab.inspection&quot;</span><span class="p">)</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># cufflinks should be in offline mode</span>
<span class="n">cf</span><span class="o">.</span><span class="n">go_offline</span><span class="p">()</span>
<span class="n">plotly</span><span class="o">.</span><span class="n">offline</span><span class="o">.</span><span class="n">init_notebook_mode</span><span class="p">(</span><span class="n">connected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>

<span class="n">_INSPECTION_MAPPING_PARAMETERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;elapsed&quot;</span><span class="p">:</span> <span class="s2">&quot;stdout__@result__elapsed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;stdout__@result__rate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;utime&quot;</span><span class="p">:</span> <span class="s2">&quot;usage__ru_utime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stime&quot;</span><span class="p">:</span> <span class="s2">&quot;usage__ru_stime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nvcsw&quot;</span><span class="p">:</span> <span class="s2">&quot;usage__ru_nvcsw&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nivcsw&quot;</span><span class="p">:</span> <span class="s2">&quot;usage__ru_nivcsw&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">_PERFORMANCE_QUANTITY</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;elapsed_time&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">]</span>

<span class="n">_PERFORMANCE_QUANTITY_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;elapsed_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Elapsed Time [ms]&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;Rate [GFLOPS]&quot;</span><span class="p">}</span>


<div class="viewcode-block" id="extract_structure_json"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.extract_structure_json">[docs]</a><span class="k">def</span> <span class="nf">extract_structure_json</span><span class="p">(</span><span class="n">input_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">upper_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">json_structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a json file structure into a list with rows showing tree depths, keys and values.</span>

<span class="sd">    :param input_json: inspection result json taken from Ceph</span>
<span class="sd">    :param upper_key: key starting point to recursively traverse all tree</span>
<span class="sd">    :param depth: depth in the tree</span>
<span class="sd">    :param json_structure: recurrent list to store results while traversing the tree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">input_json</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_json</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">json_structure</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">depth</span><span class="p">,</span> <span class="n">upper_key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]])</span>

            <span class="n">extract_structure_json</span><span class="p">(</span><span class="n">input_json</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">upper_key</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">json_structure</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_structure</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">depth</span><span class="p">,</span> <span class="n">upper_key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">input_json</span><span class="p">[</span><span class="n">key</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">json_structure</span></div>


<div class="viewcode-block" id="extract_keys_from_dataframe"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.extract_keys_from_dataframe">[docs]</a><span class="k">def</span> <span class="nf">extract_keys_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Filter the specific dataframe created for a certain key, combination of keys or for a tree depth.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">available_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Current_key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">available_combined_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Upper_keys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">available_keys</span><span class="p">:</span>
            <span class="n">ndf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Current_key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">available_combined_keys</span><span class="p">:</span>
            <span class="n">ndf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Upper_keys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The key is not in the json&quot;</span><span class="p">)</span>
            <span class="n">ndf</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;The available keys are (WARNING: Some of the keys have no leafs):</span><span class="si">{</span><span class="n">available_keys</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;The available combined keys are: </span><span class="si">{</span><span class="n">available_combined_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">max_depth</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Tree_depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;=</span> <span class="n">max_depth</span><span class="p">:</span>
            <span class="n">ndf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Tree_depth&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndf</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The maximum tree depth available is: </span><span class="si">{</span><span class="n">max_depth</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">ndf</span></div>


<div class="viewcode-block" id="aggregate_inspection_results"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.aggregate_inspection_results">[docs]</a><span class="k">def</span> <span class="nf">aggregate_inspection_results</span><span class="p">(</span>
    <span class="n">limit_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">max_ids</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">is_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">inspection_repo_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Aggregate inspection results from jsons stored in Ceph or locally from `performance` repo.</span>

<span class="sd">    :param limit_results: reduce the number of inspection reports ids considered to `max_ids` to test analysis</span>
<span class="sd">    :param max_ids: maximum number of inspection reports ids considered</span>
<span class="sd">    :param is_local: flag to retreive the dataset locally or from S3 (credentials are required)</span>
<span class="sd">    :param inspection_repo_path: required to retrieve the performance dataset locally and `is_local` is set to True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inspection_reports</span> <span class="o">=</span> <span class="n">aggregate_thoth_results</span><span class="p">(</span>
        <span class="n">limit_results</span><span class="o">=</span><span class="n">limit_results</span><span class="p">,</span>
        <span class="n">max_ids</span><span class="o">=</span><span class="n">max_ids</span><span class="p">,</span>
        <span class="n">is_local</span><span class="o">=</span><span class="n">is_local</span><span class="p">,</span>
        <span class="n">repo_path</span><span class="o">=</span><span class="n">inspection_repo_path</span><span class="p">,</span>
        <span class="n">store_name</span><span class="o">=</span><span class="s2">&quot;inspection&quot;</span><span class="p">,</span>
        <span class="n">is_inspection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">inspection_reports</span></div>


<div class="viewcode-block" id="filter_inspection_ids"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.filter_inspection_ids">[docs]</a><span class="k">def</span> <span class="nf">filter_inspection_ids</span><span class="p">(</span><span class="n">inspection_identifiers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Filter inspection ids list according to the inspection identifier selected.</span>

<span class="sd">    :param inspection_identifiers: list of identifier/s to filter inspection ids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inspection_store</span> <span class="o">=</span> <span class="n">InspectionResultsStore</span><span class="p">()</span>
    <span class="n">inspection_store</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">filtered_inspection_ids</span><span class="p">,</span> <span class="n">reduced_inspection_batch_identifiers</span> <span class="o">=</span> <span class="n">filter_document_ids</span><span class="p">(</span>
        <span class="n">inspection_store</span><span class="p">,</span> <span class="n">inspection_identifiers</span><span class="o">=</span><span class="n">inspection_identifiers</span>
    <span class="p">)</span>

    <span class="n">inspections_selected</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_n</span><span class="p">)</span> <span class="k">for</span> <span class="n">batch_n</span> <span class="ow">in</span> <span class="n">filtered_inspection_ids</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">inspection_batches</span> <span class="o">=</span> <span class="p">[(</span><span class="n">batch_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_count</span><span class="p">))</span> <span class="k">for</span> <span class="n">batch_name</span><span class="p">,</span> <span class="n">batch_count</span> <span class="ow">in</span> <span class="n">filtered_inspection_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">inspections_selected</span><span class="si">}</span><span class="s2"> inspection runs selected: </span><span class="si">{</span><span class="n">inspection_batches</span><span class="si">}</span><span class="s2"> respectively&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filtered_inspection_ids</span><span class="p">,</span> <span class="n">reduced_inspection_batch_identifiers</span></div>


<div class="viewcode-block" id="show_inspection_inputs"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.show_inspection_inputs">[docs]</a><span class="k">def</span> <span class="nf">show_inspection_inputs</span><span class="p">(</span>
    <span class="n">filtered_inspection_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">inspection_batch_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">filtered_inspection_batch_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show inspections inputs for the analysis.</span>

<span class="sd">    :param filtered_inspection_ids: list of inspection ids after filtering</span>
<span class="sd">    :param inspection_batch_ids: list of inspection batch ids</span>
<span class="sd">    :param filtered_inspection_batch_ids: llist of inspection batch ids after filtering</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_inspections</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;insepction_batch_id | Number of inspections&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">insepction_batch_id</span><span class="p">,</span> <span class="n">inspections</span> <span class="ow">in</span> <span class="n">filtered_inspection_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">insepction_batch_id</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inspections</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">total_inspections</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspections</span><span class="p">)</span>

    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial inspection batches considered: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inspection_batch_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inspections batches after filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_inspection_batch_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of inspections considered: </span><span class="si">{</span><span class="n">total_inspections</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="filter_document_ids"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.filter_document_ids">[docs]</a><span class="k">def</span> <span class="nf">filter_document_ids</span><span class="p">(</span><span class="n">inspection_store</span><span class="p">,</span> <span class="n">inspection_identifiers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Filter inspection document ids list according to the inspection identifiers selected.</span>

<span class="sd">    :param inspection_identifiers: list of identifier/s to filter inspection ids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inspection_document_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inspection_store</span><span class="o">.</span><span class="n">get_document_listing</span><span class="p">())</span>
    <span class="n">filtered_inspection_document_ids</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">inspection_document_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inspection_identifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sid</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_inspection_document_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">filtered_inspection_document_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">filtered_inspection_document_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filtered_inspection_document_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

    <span class="n">reduced_inspection_batch_identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">filtered_inspection_document_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="k">return</span> <span class="n">filtered_inspection_document_ids</span><span class="p">,</span> <span class="n">reduced_inspection_batch_identifiers</span></div>


<div class="viewcode-block" id="process_inspection_results"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.process_inspection_results">[docs]</a><span class="k">def</span> <span class="nf">process_inspection_results</span><span class="p">(</span>
    <span class="n">inspection_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="n">exclude</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">apply</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">drop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">duration_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Process inspection result into pd.DataFrame.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspection_results</span><span class="p">:</span>
        <span class="k">return</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Empty iterable provided.&quot;</span><span class="p">)</span>

    <span class="n">datetime_spec</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;created|started_at|finished_at&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">apply</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">apply</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime_spec</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">apply</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">apply</span><span class="p">,</span> <span class="n">datetime_spec</span><span class="p">]</span>

    <span class="n">exclude</span> <span class="o">=</span> <span class="n">exclude</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">apply</span> <span class="o">=</span> <span class="n">apply</span> <span class="ow">or</span> <span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">inspection_results</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;__&quot;</span><span class="p">)</span>  <span class="c1"># each row resembles InspectionResult</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">for</span> <span class="n">regex</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">apply</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">drop</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspection_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="n">rejected</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_rejected_variables</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rejected columns: &quot;</span><span class="p">,</span> <span class="n">rejected</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">rejected</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">duration_info</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span>
            <span class="s2">&quot;status__job__duration = status__job__finished_at - status__job__started_at&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;status__build__duration = status__build__finished_at - status__build__started_at&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="aggregate_inspection_results_per_identifier"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.aggregate_inspection_results_per_identifier">[docs]</a><span class="k">def</span> <span class="nf">aggregate_inspection_results_per_identifier</span><span class="p">(</span>
    <span class="n">inspection_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">identifier_inspection</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">inspection_batch_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Aggregate inspection results per identifier from inspection documents stored in Ceph.</span>

<span class="sd">    :param inspection_ids: list of inspection ids</span>
<span class="sd">    :param identifier_inspection: list of identifier/s to filter inspection ids</span>
<span class="sd">    :param inspection_batch_data: info to be added to each inspection (e.g. specification)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inspection_store</span> <span class="o">=</span> <span class="n">InspectionResultsStore</span><span class="p">()</span>
    <span class="n">inspection_store</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">inspection_results_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">number_inspection_ids</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">inspection_ids</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">current_identifier</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">inspections_error_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">identifier_batch</span> <span class="ow">in</span> <span class="n">identifier_inspection</span><span class="p">:</span>
        <span class="n">inspection_results_dict</span><span class="p">[</span><span class="n">identifier_batch</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Analyzing inspection identifer batch: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">identifier_batch</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inspection_ids</span><span class="p">[</span><span class="n">identifier_batch</span><span class="p">]):</span>
            <span class="n">current_identifier</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis n.</span><span class="si">{</span><span class="n">current_identifier</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">number_inspection_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Dockerfile&quot;</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dockerfile&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;specification&quot;</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;specification&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">specification</span> <span class="o">=</span> <span class="n">extract_specification</span><span class="p">(</span><span class="n">inspection_batch_result</span><span class="o">=</span><span class="n">inspection_batch_data</span><span class="p">,</span> <span class="n">inspection_id</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">specification</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">document</span> <span class="o">=</span> <span class="n">inspection_store</span><span class="o">.</span><span class="n">retrieve_document</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                        <span class="n">document</span><span class="p">[</span><span class="s2">&quot;requirements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specification</span><span class="p">[</span><span class="s2">&quot;requirements&quot;</span><span class="p">]</span>
                        <span class="n">document</span><span class="p">[</span><span class="s2">&quot;requirements_locked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specification</span><span class="p">[</span><span class="s2">&quot;requirements_locked&quot;</span><span class="p">]</span>
                        <span class="n">document</span><span class="p">[</span><span class="s2">&quot;runtime_environment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specification</span><span class="p">[</span><span class="s2">&quot;runtime_environment&quot;</span><span class="p">]</span>
                        <span class="c1"># pop build logs to save some memory (not necessary for now)</span>
                        <span class="n">document</span><span class="p">[</span><span class="s2">&quot;build_log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
                        <span class="n">inspection_results_dict</span><span class="p">[</span><span class="n">identifier_batch</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">inspections_error_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">continue</span>

    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total number of inspections considered: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">number_inspection_ids</span><span class="p">)</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total number of inspections with error: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inspections_error_counter</span><span class="p">)</span>
    <span class="n">percentage_error</span> <span class="o">=</span> <span class="n">inspections_error_counter</span> <span class="o">/</span> <span class="n">number_inspection_ids</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Percentage of error in inspection results: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">percentage_error</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inspection_results_dict</span></div>


<div class="viewcode-block" id="extract_specification"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.extract_specification">[docs]</a><span class="k">def</span> <span class="nf">extract_specification</span><span class="p">(</span><span class="n">inspection_batch_result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">inspection_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract specification info for the inspection.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">inspection_batches</span> <span class="ow">in</span> <span class="n">inspection_batch_result</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

        <span class="k">for</span> <span class="n">inspection_batch</span> <span class="ow">in</span> <span class="n">inspection_batches</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">inspection_batch</span> <span class="ow">in</span> <span class="n">inspection_id</span><span class="p">:</span>

                <span class="n">specification</span> <span class="o">=</span> <span class="n">inspection_batches</span><span class="p">[</span><span class="n">inspection_batch</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">specification</span></div>


<div class="viewcode-block" id="create_duration_dataframe"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_duration_dataframe">[docs]</a><span class="k">def</span> <span class="nf">create_duration_dataframe</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute statistics and duration DataFrame.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Empty DataFrame provided&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">inspection_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;build_log&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">inspection_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;duration&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;status__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ts</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_duration_stats</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">group</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;job_duration_mean      = job_duration.mean()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;job_duration_upper_bound    = job_duration + job_duration.std()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;job_duration_lower_bound    = job_duration - job_duration.std()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;build_duration_mean         = build_duration.mean()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;build_duration_upper_bound  = build_duration + build_duration.std()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;build_duration_lower_bound  = build_duration - build_duration.std()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inspection_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
        <span class="n">n_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspection_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span>

        <span class="c1"># compute duration stats for each group separately</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">compute_duration_stats</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">compute_duration_stats</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_duration_box"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_duration_box">[docs]</a><span class="k">def</span> <span class="nf">create_duration_box</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create duration Box plot.&quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;duration$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">figure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;InspectionRun duration&quot;</span><span class="p">),</span> <span class="n">yTitle</span><span class="o">=</span><span class="s2">&quot;duration [s]&quot;</span><span class="p">,</span> <span class="n">asFigure</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">figure</span></div>


<div class="viewcode-block" id="create_duration_scatter"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_duration_scatter">[docs]</a><span class="k">def</span> <span class="nf">create_duration_scatter</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create duration Scatter plot.&quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;duration$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">figure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;InspectionRun duration&quot;</span><span class="p">),</span>
        <span class="n">yTitle</span><span class="o">=</span><span class="s2">&quot;duration [s]&quot;</span><span class="p">,</span>
        <span class="n">xTitle</span><span class="o">=</span><span class="s2">&quot;inspection ID&quot;</span><span class="p">,</span>
        <span class="n">asFigure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">figure</span></div>


<div class="viewcode-block" id="create_duration_scatter_with_bounds"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_duration_scatter_with_bounds">[docs]</a><span class="k">def</span> <span class="nf">create_duration_scatter_with_bounds</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create duration Scatter plot with upper and lower bounds.&quot;&quot;&quot;</span>
    <span class="n">df_duration</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">data</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;upper_bound = </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">.std()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lower_bound = </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">.std()&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df_duration</span><span class="o">.</span><span class="n">index</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Upper Bound&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">df_duration</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">),</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">fillcolor</span><span class="o">=</span><span class="s2">&quot;rgba(68, 68, 68, 0.3)&quot;</span><span class="p">,</span>
        <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tonexty&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Duration&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">df_duration</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;rgb(31, 119, 180)&quot;</span><span class="p">),</span>
        <span class="n">fillcolor</span><span class="o">=</span><span class="s2">&quot;rgba(68, 68, 68, 0.3)&quot;</span><span class="p">,</span>
        <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tonexty&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Lower Bound&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">df_duration</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">),</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">df_duration</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;duration [s]&quot;</span><span class="p">),</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;inspection ID&quot;</span><span class="p">),</span>
        <span class="n">shapes</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="s2">&quot;y0&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="s2">&quot;longdash&quot;</span><span class="p">}}</span>
        <span class="p">],</span>
        <span class="n">title</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;InspectionRun duration&quot;</span><span class="p">),</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="create_duration_histogram"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_duration_histogram">[docs]</a><span class="k">def</span> <span class="nf">create_duration_histogram</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create duration Histogram plot.&quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;duration$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">bins</span><span class="p">:</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">histograms</span><span class="o">.</span><span class="n">_hist_bin_auto</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">])</span>

    <span class="n">figure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;InspectionRun distribution&quot;</span><span class="p">),</span>
        <span class="n">yTitle</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="n">xTitle</span><span class="o">=</span><span class="s2">&quot;durations [s]&quot;</span><span class="p">,</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bins</span><span class="p">)),</span>
        <span class="n">asFigure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">figure</span></div>


<div class="viewcode-block" id="query_inspection_dataframe"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.query_inspection_dataframe">[docs]</a><span class="k">def</span> <span class="nf">query_inspection_dataframe</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Wrapper around _.query method which always include `duration` columns in filter expression.&quot;&quot;&quot;</span>
    <span class="n">like</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;like&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;regex&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">like</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="o">.</span><span class="n">_</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">like</span><span class="o">=</span><span class="n">like</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">)):</span>
            <span class="c1"># duration columns must be present</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inspection_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;duration&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">elif</span> <span class="n">regex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">+=</span> <span class="s2">&quot;|(.*duration)&quot;</span>

    <span class="k">return</span> <span class="n">inspection_df</span><span class="o">.</span><span class="n">_</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">like</span><span class="o">=</span><span class="n">like</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_subplots"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.make_subplots">[docs]</a><span class="k">def</span> <span class="nf">make_subplots</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make subplots and arrange them in an optimized grid layout.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="s2">&quot;histogram&quot;</span><span class="p">,</span> <span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="s2">&quot;scatter_with_bounds&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can NOT handle plot of kind: </span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can only handle hierarchical index of depth &lt;= 2, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2">. Grouping index.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">group_index</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">columns</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">create_facet_grid</span><span class="p">(</span>
        <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
        <span class="n">facet_row</span><span class="o">=</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">facet_col</span><span class="o">=</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">trace_type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>  <span class="c1"># box does not need data specification</span>
        <span class="n">ggplot2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">_grid_ref</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">sub_plots</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">cols</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">shared_yaxes</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;shared_yaxes&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">shared_xaxes</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;shared_xaxes&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">print_grid</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;print_grid&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
        <span class="n">index_grid</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">index</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index_grid</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;scatter_with_bounds&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`scatter_with_bounds` requires `col` argument, not provided.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">columns</span><span class="p">,</span> <span class="o">=</span> <span class="n">columns</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`scatter_with_bounds` does not allow for multiple columns.&quot;</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;create_duration_</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">(grp, columns, **kwargs)&quot;</span><span class="p">)</span>

        <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">index_grid</span><span class="p">))</span>  <span class="c1"># col-first plotting</span>
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">sub_plots</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">layout</span> <span class="o">=</span> <span class="n">sub_plots</span><span class="o">.</span><span class="n">layout</span>
    <span class="n">layout</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">title</span><span class="p">),</span>
        <span class="n">shapes</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">shapes</span><span class="p">,</span>
        <span class="n">annotations</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">x_dom_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">to_plotly_json</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;xaxis&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">y_dom_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">to_plotly_json</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;yaxis&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>

    <span class="n">layout_shapes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">to_plotly_json</span><span class="p">()[</span><span class="s2">&quot;shapes&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;y0&quot;</span><span class="p">])</span>

    <span class="n">h_shapes</span> <span class="o">=</span> <span class="n">layout_shapes</span><span class="p">[</span><span class="o">~</span><span class="n">layout_shapes</span><span class="o">.</span><span class="n">x0</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
    <span class="n">v_shapes</span> <span class="o">=</span> <span class="n">layout_shapes</span><span class="p">[</span><span class="o">~</span><span class="n">layout_shapes</span><span class="o">.</span><span class="n">y0</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

    <span class="c1"># handle single-columns</span>
    <span class="n">h_shapes</span> <span class="o">=</span> <span class="n">h_shapes</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;y1 - y0 != 1&quot;</span><span class="p">)</span>
    <span class="n">v_shapes</span> <span class="o">=</span> <span class="n">v_shapes</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;x1 - x0 != 1&quot;</span><span class="p">)</span>

    <span class="c1"># update axis domains and layout</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x_axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_dom_vals</span><span class="p">):</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">h_shapes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span> <span class="o">%</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]][[</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">]]</span>

        <span class="n">layout</span><span class="p">[</span><span class="n">x_axis</span><span class="p">]</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="mf">0.03</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="mf">0.03</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">[</span><span class="n">x_axis</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">y_axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_dom_vals</span><span class="p">):</span>
        <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">v_shapes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span> <span class="o">%</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]][[</span><span class="s2">&quot;y0&quot;</span><span class="p">,</span> <span class="s2">&quot;y1&quot;</span><span class="p">]]</span>

        <span class="n">layout</span><span class="p">[</span><span class="n">y_axis</span><span class="p">]</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="p">(</span><span class="n">y0</span> <span class="o">+</span> <span class="mf">0.03</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="mf">0.03</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">[</span><span class="n">y_axis</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># correct annotation to match the relevant group and width</span>
    <span class="n">annot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">to_plotly_json</span><span class="p">()[</span><span class="s2">&quot;annotations&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
    <span class="n">annot_df</span> <span class="o">=</span> <span class="n">annot_df</span><span class="p">[</span><span class="n">annot_df</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">aw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>  <span class="c1"># annotation width magic</span>
        <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">60</span> <span class="o">/</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">6</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">30</span> <span class="o">/</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">6</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">annot_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">annot_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="n">annot</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">annot_idx</span><span class="p">]</span>

        <span class="n">index_label</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="n">index_axis</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># no worries, the order and label are aight</span>
            <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">index_label</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">index_axis</span><span class="p">][</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_label</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">index_axis</span><span class="p">][</span><span class="n">i</span> <span class="o">%</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_label</span><span class="p">)</span>

        <span class="n">annot</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.{</span><span class="si">%d</span><span class="s2">}).*(.{</span><span class="si">%d</span><span class="s2">})$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aw</span><span class="p">,</span> <span class="n">aw</span><span class="p">),</span> <span class="s2">&quot;\g&lt;1&gt;...\g&lt;2&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># Ignore PycodestyleBear (W605)</span>
        <span class="n">annot</span><span class="p">[</span><span class="s2">&quot;hovertext&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">index_label</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="c1"># add axis titles as plot annotations</span>
    <span class="n">layout</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">*</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="s2">&quot;xref&quot;</span><span class="p">:</span> <span class="s2">&quot;paper&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yref&quot;</span><span class="p">:</span> <span class="s2">&quot;paper&quot;</span><span class="p">,</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">xaxis</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
            <span class="s2">&quot;showarrow&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;xref&quot;</span><span class="p">:</span> <span class="s2">&quot;paper&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yref&quot;</span><span class="p">:</span> <span class="s2">&quot;paper&quot;</span><span class="p">,</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">yaxis</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
            <span class="s2">&quot;textangle&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span>
            <span class="s2">&quot;showarrow&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># custom user layout updates</span>
    <span class="n">user_layout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;layout&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user_layout</span><span class="p">:</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_layout</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sub_plots</span></div>


<div class="viewcode-block" id="show_categories"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.show_categories">[docs]</a><span class="k">def</span> <span class="nf">show_categories</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List categories in the given inspection pd.DataFrame.&quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="n">results_categories</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Class </span><span class="si">{</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">class_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">class_results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">class_results</span><span class="p">[</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">results_categories</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_results</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of rows (jobs) is: </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results_categories</span></div>


<div class="viewcode-block" id="create_inspection_dataframes"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_inspection_dataframes">[docs]</a><span class="k">def</span> <span class="nf">create_inspection_dataframes</span><span class="p">(</span><span class="n">inspection_results_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">duration_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create dictionary with data frame as returned by `process_inspection_results&#39; for each inspection identifier.</span>

<span class="sd">    :param inspection_results_dict: dictionary containing inspection results per inspection identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inspection_df_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">identifier_counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">total_identifier</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspection_results_dict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">inspection_results_list</span> <span class="ow">in</span> <span class="n">inspection_results_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing inspection batch: </span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">identifier_counter</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_identifier</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">process_inspection_results</span><span class="p">(</span>
            <span class="n">inspection_results_list</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;build_log&quot;</span><span class="p">,</span> <span class="s2">&quot;created&quot;</span><span class="p">,</span> <span class="s2">&quot;inspection_id&quot;</span><span class="p">],</span>
            <span class="n">apply</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;created|started_at|finished_at&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">)],</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">inspection_df_dict</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_list</span><span class="p">:</span>
                <span class="n">columns_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">duration_info</span><span class="p">:</span>
            <span class="n">df_duration</span> <span class="o">=</span> <span class="n">create_duration_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">inspection_df_dict</span><span class="p">[</span><span class="n">identifier</span><span class="p">][</span><span class="s2">&quot;job_duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_duration</span><span class="p">[</span><span class="s2">&quot;job_duration&quot;</span><span class="p">]</span>
            <span class="n">inspection_df_dict</span><span class="p">[</span><span class="n">identifier</span><span class="p">][</span><span class="s2">&quot;build_duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_duration</span><span class="p">[</span><span class="s2">&quot;build_duration&quot;</span><span class="p">]</span>

        <span class="n">inspections_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_list</span><span class="p">)</span>
        <span class="n">identifier_counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">inspection_df_dict</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No inspections identified.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inspection_df_dict</span><span class="p">,</span> <span class="n">inspections_df</span>

    <span class="n">_INSPECTION_PERFORMANCE_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stdout__@result__elapsed&quot;</span><span class="p">,</span> <span class="s2">&quot;stdout__@result__rate&quot;</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dataframe</span> <span class="ow">in</span> <span class="n">inspection_df_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">evaluate_statistics_on_inspection_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">column_names</span><span class="o">=</span><span class="n">_INSPECTION_PERFORMANCE_VALUES</span><span class="p">)</span>
        <span class="n">inspections_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">inspection_df_dict</span><span class="p">,</span> <span class="n">inspections_df</span></div>


<div class="viewcode-block" id="evaluate_statistics_on_inspection_df"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.evaluate_statistics_on_inspection_df">[docs]</a><span class="k">def</span> <span class="nf">evaluate_statistics_on_inspection_df</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Evaluate statistics on performance values selected from Dataframe columns.&quot;&quot;&quot;</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
            <span class="n">new_data</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_data</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_python_package_df"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_python_package_df">[docs]</a><span class="k">def</span> <span class="nf">create_python_package_df</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Create DataFrame with only python packages present in software stacks.&quot;&quot;&quot;</span>
    <span class="n">python_packages_versions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">python_packages_versions_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sws_df</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">inspection_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="s2">&quot;__index&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">sws_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;__index&quot;</span> <span class="ow">in</span> <span class="n">c_name</span><span class="p">:</span>
            <span class="n">python_packages_versions_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">python_packages_versions_names</span><span class="p">:</span>
        <span class="n">package_info</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="n">col</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">inspection_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">package</span><span class="p">,</span> <span class="s2">&quot;__index&quot;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">package</span><span class="p">,</span> <span class="s2">&quot;__version&quot;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">col</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">package_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">package_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">package_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">version</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">package</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">python_packages_versions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">python_packages_versions</span><span class="p">[</span><span class="n">package</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">python_packages_versions</span><span class="p">[</span><span class="n">package</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">python_packages_versions</span><span class="p">[</span><span class="n">package</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">package</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">python_packages_versions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">python_packages_versions</span><span class="p">[</span><span class="n">package</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">python_packages_versions</span><span class="p">[</span><span class="n">package</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">package</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">python_packages_versions</span><span class="p">[</span><span class="n">package</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">package</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">python_packages_versions</span><span class="p">),</span> <span class="n">python_packages_versions</span></div>


<div class="viewcode-block" id="create_final_dataframe"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_final_dataframe">[docs]</a><span class="k">def</span> <span class="nf">create_final_dataframe</span><span class="p">(</span>
    <span class="n">packages_versions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">python_packages_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">inspection_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create final dataframe with all information required for plots.</span>

<span class="sd">    :param packages_versions: dict as returned by `create_python_package_df` method.</span>
<span class="sd">    :param python_packages_dataframe: data frame as returned by `create_python_package_df` method.</span>
<span class="sd">    :param inspection_df: data frame containing data of inspections results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

    <span class="n">processed_string_result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">packages_versions</span><span class="p">)</span>

    <span class="n">sws_encoded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">python_packages_dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">sws_string</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span> <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">pkg</span> <span class="o">!=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)])</span>
        <span class="n">hash_object</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">sws_string</span><span class="p">,</span> <span class="s2">&quot;raw_unicode_escape&quot;</span><span class="p">))</span>
        <span class="n">hex_dig</span> <span class="o">=</span> <span class="n">hash_object</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">sws_encoded</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sws_string</span><span class="p">,</span> <span class="n">hex_dig</span><span class="p">])</span>

    <span class="n">re_encoded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">inspection_df</span><span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;os_release__id&quot;</span><span class="p">,</span> <span class="s2">&quot;os_release__version_id&quot;</span><span class="p">,</span> <span class="s2">&quot;requirements__requires__python_version&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">re_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span> <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="n">re_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;py&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))])</span>
        <span class="n">re_string</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re_values</span><span class="p">)</span>
        <span class="n">hash_object</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">re_string</span><span class="p">,</span> <span class="s2">&quot;raw_unicode_escape&quot;</span><span class="p">))</span>
        <span class="n">hex_dig</span> <span class="o">=</span> <span class="n">hash_object</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">re_encoded</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">re_string</span><span class="p">,</span> <span class="n">hex_dig</span><span class="p">])</span>

    <span class="c1"># Software Stack encoding</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;packages_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">sws_encoded</span><span class="p">]</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;sws_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">sws_encoded</span><span class="p">]</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;sws_hash_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">sws_encoded</span><span class="p">]</span>

    <span class="n">sws_hash_id_values</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">pp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">sws_encoded</span><span class="p">])</span>
    <span class="c1"># print(y_values)</span>
    <span class="n">integer_sws_hash_id_values_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">sws_hash_id_values</span><span class="p">)</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;sws_hash_id_encoded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integer_sws_hash_id_values_encoded</span>

    <span class="c1"># Runtime Environment encoding</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;runtime_environment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">re_encoded</span><span class="p">]</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;re_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">re_encoded</span><span class="p">]</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;re_hash_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">re_encoded</span><span class="p">]</span>

    <span class="c1"># PI</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;pi_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pi_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pi_n</span> <span class="ow">in</span> <span class="n">inspection_df</span><span class="p">[[</span><span class="s2">&quot;stdout__name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;pi_component&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pi_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pi_c</span> <span class="ow">in</span> <span class="n">inspection_df</span><span class="p">[[</span><span class="s2">&quot;stdout__component&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;pi_sha256&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pi_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pi_c</span> <span class="ow">in</span> <span class="n">inspection_df</span><span class="p">[[</span><span class="s2">&quot;script_sha256&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="c1"># PI performance results</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;elapsed_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r_e</span> <span class="ow">in</span> <span class="n">inspection_df</span><span class="p">[[</span><span class="s2">&quot;stdout__@result__elapsed&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="n">processed_string_result</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r_r</span> <span class="ow">in</span> <span class="n">inspection_df</span><span class="p">[[</span><span class="s2">&quot;stdout__@result__rate&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">processed_string_result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_df</span></div>


<div class="viewcode-block" id="create_filtered_df"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_filtered_df">[docs]</a><span class="k">def</span> <span class="nf">create_filtered_df</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">pi_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pi_component</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">runtime_environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">packages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create dataframe using the filters selected for plots.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataFrame provided is empty, nothing can be filtered.&quot;</span><span class="p">)</span>

    <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">pi_name</span><span class="p">:</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;pi_name&quot;</span><span class="p">,</span> <span class="n">pi_name</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pi_component</span><span class="p">:</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;pi_component&quot;</span><span class="p">,</span> <span class="n">pi_component</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">runtime_environment</span><span class="p">:</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;re_string&quot;</span><span class="p">,</span> <span class="n">runtime_environment</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">packages</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">package</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">package</span><span class="p">))</span>

    <span class="n">filtered_final_df</span> <span class="o">=</span> <span class="n">filter_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_final_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;There are no results for the filters selected. Please change filters.&quot;</span><span class="p">)</span>

    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of software stacks identified: </span><span class="si">{</span><span class="n">filtered_final_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filtered_final_df</span></div>


<div class="viewcode-block" id="filter_df"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.filter_df">[docs]</a><span class="k">def</span> <span class="nf">filter_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Filter Dataframe.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="create_inspection_3d_plot"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_inspection_3d_plot">[docs]</a><span class="k">def</span> <span class="nf">create_inspection_3d_plot</span><span class="p">(</span><span class="n">plot_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">identifiers_inspections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Create inspection performance parameters plot in 3D.</span>

<span class="sd">    :param plot_df dataframe for plot of inspections results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">quantity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_PERFORMANCE_QUANTITY</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="n">_PERFORMANCE_QUANTITY</span><span class="si">}</span><span class="s2"> are accepted as quantity&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

    <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="p">[[</span><span class="s2">&quot;re_string&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="n">integer_y_encoded</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="p">[[</span><span class="s2">&quot;sws_hash_id_encoded&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="n">Z</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="p">[[</span><span class="n">quantity</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="n">trace1</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">integer_y_encoded</span><span class="p">,</span>
        <span class="n">z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="n">hovertext</span><span class="o">=</span><span class="p">[</span><span class="n">yc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">yc</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="p">[[</span><span class="s2">&quot;sws_string&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>
        <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span>  <span class="c1"># set color to an array/list of desired values</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>  <span class="c1"># choose a colorscale</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;PI=Conv2D-tensorflow-</span><span class="si">{</span><span class="n">identifiers_inspections</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">trace1</span><span class="p">]</span>

    <span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">integer_y_encoded</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
        <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span>
                <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">xshift</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">margin</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;PI=Conv2D&quot;</span><span class="p">,</span>
        <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
        <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Runtime Environment&quot;</span><span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Software Stack ID integer encoded&quot;</span><span class="p">),</span>
            <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">_PERFORMANCE_QUANTITY_MAP</span><span class="p">[</span><span class="n">quantity</span><span class="p">]),</span>
            <span class="c1">#         annotations=annotations,</span>
        <span class="p">),</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

    <span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;3d-scatter-colorscale&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_inspection_2d_plot"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_inspection_2d_plot">[docs]</a><span class="k">def</span> <span class="nf">create_inspection_2d_plot</span><span class="p">(</span>
    <span class="n">plot_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">components</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">color_scales</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">identifiers_inspections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">have_annotations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create inspection performance parameters plot in 2D.</span>

<span class="sd">    :param plot_df dataframe for plot of inspections results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">integer_y_encoded</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="p">[[</span><span class="s2">&quot;sws_hash_id_encoded&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
        <span class="n">name_component</span> <span class="o">=</span> <span class="n">component</span>
        <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;pytorch&quot;</span><span class="p">:</span>
            <span class="n">name_component</span> <span class="o">=</span> <span class="s2">&quot;torch&quot;</span>
        <span class="n">subset_df</span> <span class="o">=</span> <span class="n">plot_df</span><span class="p">[</span><span class="n">plot_df</span><span class="p">[</span><span class="s2">&quot;pi_component&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">component</span><span class="p">]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">subset_df</span><span class="p">[[</span><span class="n">quantity</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">integer_y_encoded</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="n">hovertext</span><span class="o">=</span><span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">subset_df</span><span class="p">[[</span><span class="s2">&quot;sws_string&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span>  <span class="c1"># set color to an array/list of desired values</span>
                <span class="n">colorscale</span><span class="o">=</span><span class="n">color_scales</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>  <span class="c1"># choose a colorscale</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">colorbar</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">d</span><span class="p">},</span>
            <span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">==version&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">d</span> <span class="o">+=</span> <span class="mf">0.2</span>

        <span class="k">if</span> <span class="n">have_annotations</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">zr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">integer_y_encoded</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
                <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">yr</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">zr</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_component</span><span class="si">}{</span><span class="n">subset_df</span><span class="p">[</span><span class="n">name_component</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;np</span><span class="si">{</span><span class="n">subset_df</span><span class="p">[</span><span class="n">name_component</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                        <span class="n">xshift</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;PI=Conv2D-</span><span class="si">{</span><span class="n">components</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">identifiers_inspections</span><span class="si">}</span><span class="s2">-2Dplot&quot;</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Software Stack ID integer encoded&quot;</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">_PERFORMANCE_QUANTITY_MAP</span><span class="p">[</span><span class="n">quantity</span><span class="p">]),</span>
        <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>

    <span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;scatter-colorscale&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_inspection_analysis_plots"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_inspection_analysis_plots">[docs]</a><span class="k">def</span> <span class="nf">create_inspection_analysis_plots</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create inspection analysis plots for the inspection pd.Dataframe.</span>

<span class="sd">    :param inspection_df: data frame as returned by `process_inspection_results&#39; for a specific inspection identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Box plots job duration and build duration</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">create_duration_box</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;build_duration&quot;</span><span class="p">,</span> <span class="s2">&quot;job_duration&quot;</span><span class="p">])</span>

    <span class="n">py</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="c1"># Scatter job duration</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">create_duration_scatter</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">,</span> <span class="s2">&quot;job_duration&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;InspectionRun job duration&quot;</span><span class="p">)</span>

    <span class="n">py</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="c1"># Scatter build duration</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">create_duration_scatter</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">,</span> <span class="s2">&quot;build_duration&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;InspectionRun build duration&quot;</span><span class="p">)</span>

    <span class="n">py</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="c1"># Histogram</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">create_duration_histogram</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;job_duration&quot;</span><span class="p">])</span>

    <span class="n">py</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_inspection_parameters_dataframes"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_inspection_parameters_dataframes">[docs]</a><span class="k">def</span> <span class="nf">create_inspection_parameters_dataframes</span><span class="p">(</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">inspection_df_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Create pd.DataFrame of selected parameters from inspections results to be used for statistics and error analysis.</span>

<span class="sd">    It also outputs batches and parameters map that is necessary for plots.</span>

<span class="sd">    :param parameters: inspection parameters used in the analysis</span>
<span class="sd">    :param inspection_df_dict: dictionary with data frame as returned by `process_inspection_results&#39; per identifier.</span>
<span class="sd">    :param component: PI component name (e.g tensorflow, pytorch).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inspection_parameters_df_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">parameter_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">inspection_df_dict</span><span class="p">:</span>
            <span class="n">additional</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">current_inspection_df</span> <span class="o">=</span> <span class="n">inspection_df_dict</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">component</span><span class="p">:</span>
                <span class="n">filtered_inspection_df</span> <span class="o">=</span> <span class="n">current_inspection_df</span><span class="p">[</span>
                    <span class="n">current_inspection_df</span><span class="p">[</span><span class="s2">&quot;stdout__component&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">component</span>
                <span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">filtered_inspection_df</span><span class="p">[</span><span class="n">_INSPECTION_MAPPING_PARAMETERS</span><span class="p">[</span><span class="n">parameter</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">additional</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="n">parameter_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">parameter_df</span><span class="p">,</span> <span class="n">additional</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">current_inspection_df</span><span class="p">[</span><span class="n">_INSPECTION_MAPPING_PARAMETERS</span><span class="p">[</span><span class="n">parameter</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">additional</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">parameter_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">parameter_df</span><span class="p">,</span> <span class="n">additional</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">inspection_parameters_df_dict</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_df</span>

    <span class="k">return</span> <span class="n">inspection_parameters_df_dict</span></div>


<div class="viewcode-block" id="evaluate_statistics"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.evaluate_statistics">[docs]</a><span class="k">def</span> <span class="nf">evaluate_statistics</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">inspection_parameter</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Evaluate statistical quantities of a specific parameter of inspection results.&quot;&quot;&quot;</span>
    <span class="n">std_error</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mf">0.25</span><span class="p">]</span>
    <span class="n">q3</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mf">0.75</span><span class="p">]</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>
    <span class="n">cv_mean</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">cv_median</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">cv_q1</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">q1</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">cv_q3</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">q3</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">maxr</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">minr</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="n">inspection_parameter</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;cv_mean&quot;</span><span class="p">:</span> <span class="n">cv_mean</span><span class="p">,</span>
        <span class="s2">&quot;cv_median&quot;</span><span class="p">:</span> <span class="n">cv_median</span><span class="p">,</span>
        <span class="s2">&quot;cv_q1&quot;</span><span class="p">:</span> <span class="n">cv_q1</span><span class="p">,</span>
        <span class="s2">&quot;cv_q3&quot;</span><span class="p">:</span> <span class="n">cv_q3</span><span class="p">,</span>
        <span class="s2">&quot;std_error&quot;</span><span class="p">:</span> <span class="n">std_error</span><span class="p">,</span>
        <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">std</span><span class="p">,</span>
        <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">median</span><span class="p">,</span>
        <span class="s2">&quot;q1&quot;</span><span class="p">:</span> <span class="n">q1</span><span class="p">,</span>
        <span class="s2">&quot;q3&quot;</span><span class="p">:</span> <span class="n">q3</span><span class="p">,</span>
        <span class="s2">&quot;iqr&quot;</span><span class="p">:</span> <span class="n">iqr</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">maxr</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">minr</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="evaluate_inspection_statistics"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.evaluate_inspection_statistics">[docs]</a><span class="k">def</span> <span class="nf">evaluate_inspection_statistics</span><span class="p">(</span><span class="n">parameters</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">inspection_df_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Aggregate statistical quantities per inspection parameter for inspection batches.</span>

<span class="sd">    :param parameters: inspection parameters used in the analysis</span>
<span class="sd">    :param inspection_df_dict: dictionary with data frame as returned by `process_inspection_results&#39; per identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_STATISTICAL_PARAMETERS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;cv_mean&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cv_median&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cv_q1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cv_q3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;std_error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;std&quot;</span><span class="p">,</span>
        <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="s2">&quot;q1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;q3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iqr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">,</span>
        <span class="s2">&quot;min&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">inspection_statistics_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">IDENTIFIER_INSPECTIONS_REDUCED</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">evaluated_statistics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">inspection_df_dict</span><span class="p">:</span>
            <span class="n">current_inspection_df</span> <span class="o">=</span> <span class="n">inspection_df_dict</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">component</span><span class="p">:</span>
                <span class="n">filtered_inspection_df</span> <span class="o">=</span> <span class="n">current_inspection_df</span><span class="p">[</span>
                    <span class="n">current_inspection_df</span><span class="p">[</span><span class="s2">&quot;stdout__component&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">component</span>
                <span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">evaluate_statistics</span><span class="p">(</span>
                    <span class="n">inspection_df</span><span class="o">=</span><span class="n">filtered_inspection_df</span><span class="p">,</span> <span class="n">inspection_parameter</span><span class="o">=</span><span class="n">_INSPECTION_MAPPING_PARAMETERS</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="n">IDENTIFIER_INSPECTIONS_REDUCED</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                    <span class="n">evaluated_statistics</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="n">aggregated_statistics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">statistical_quantity</span> <span class="ow">in</span> <span class="n">_STATISTICAL_PARAMETERS</span><span class="p">:</span>
            <span class="n">aggregated_statistics</span><span class="p">[</span><span class="n">statistical_quantity</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">values</span><span class="p">[</span><span class="n">statistical_quantity</span><span class="p">]</span> <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">evaluated_statistics</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">]</span>

        <span class="n">inspection_statistics_dict</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregated_statistics</span>

    <span class="k">return</span> <span class="n">inspection_statistics_dict</span><span class="p">,</span> <span class="n">IDENTIFIER_INSPECTIONS_REDUCED</span></div>


<div class="viewcode-block" id="plot_interpolated_statistics_of_inspection_parameters"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.plot_interpolated_statistics_of_inspection_parameters">[docs]</a><span class="k">def</span> <span class="nf">plot_interpolated_statistics_of_inspection_parameters</span><span class="p">(</span>
    <span class="n">statistical_results_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">identifier_inspection_list</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">inspection_parameters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">colour_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">statistical_quantities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">title_plot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">title_xlabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">title_ylabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">project_folder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">folder_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">componet</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot interpolated statistical quantity/ies of inspection parameter/s from different inspection batches.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspection_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">statistical_quantities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colour_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statistical_quantities</span><span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List of statistical quantities and List of colours shall have the same length!&quot;</span><span class="p">)</span>

        <span class="n">parameter_results</span> <span class="o">=</span> <span class="n">statistical_results_dict</span><span class="p">[</span><span class="n">inspection_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">statistical_quantities</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">identifier_inspection_list</span><span class="p">,</span> <span class="n">parameter_results</span><span class="p">[</span><span class="n">quantity</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">colour_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">quantity</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">title_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title_plot</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspection_parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">statistical_quantities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspection_parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colour_list</span><span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List of inspection parameters and List of colours shall have the same length!&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inspection_parameters</span><span class="p">):</span>
            <span class="n">parameter_results</span> <span class="o">=</span> <span class="n">statistical_results_dict</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">identifier_inspection_list</span><span class="p">,</span>
                <span class="n">parameter_results</span><span class="p">[</span><span class="n">statistical_quantities</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">colour_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">o-&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">parameter</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title_plot</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspection_parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">statistical_quantities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colour_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statistical_quantities</span><span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List of statistical quantities and List of colours shall have the same length!&quot;</span><span class="p">)</span>

        <span class="n">parameter_results</span> <span class="o">=</span> <span class="n">statistical_results_dict</span><span class="p">[</span><span class="n">inspection_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">statistical_quantities</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">identifier_inspection_list</span><span class="p">,</span> <span class="n">parameter_results</span><span class="p">[</span><span class="n">quantity</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">colour_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">quantity</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title_plot</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;Combinations allowed:</span>
<span class="sd">                - single inspection parameter | single or multiple statistical quantity/ies</span>
<span class="sd">                - single or multiple inspection parameter/s | single statistical quantity</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">title_xlabel</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">title_xlabel</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title_ylabel</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">title_ylabel</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">save_result</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">project_folder</span><span class="p">:</span>
            <span class="n">current_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
            <span class="n">project_dir_path</span> <span class="o">=</span> <span class="n">current_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">project_folder</span><span class="p">)</span>

            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Project folder (if not already created!!)&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">project_dir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">folder_name</span><span class="p">:</span>
                <span class="n">new_dir_path</span> <span class="o">=</span> <span class="n">project_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">folder_name</span><span class="p">)</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating sub-folder (if not already created!!)&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_dir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_dir_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">title_plot</span><span class="si">}</span><span class="s2">_static.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">title_plot</span><span class="si">}</span><span class="s2">_static.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No project folder name provided!!&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_inspection_time_dataframe"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_inspection_time_dataframe">[docs]</a><span class="k">def</span> <span class="nf">create_inspection_time_dataframe</span><span class="p">(</span><span class="n">df_inspection_batches_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">n_parallel</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create pd.Dataframe of time of inspections for build and job.&quot;&quot;&quot;</span>
    <span class="n">tot_time_builds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tot_time_jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tot_time_sum_builds_and_jobs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">dataframe</span> <span class="ow">in</span> <span class="n">df_inspection_batches_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">tot_time_builds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;build_duration&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3600</span> <span class="o">/</span> <span class="n">n_parallel</span><span class="p">)</span>
        <span class="n">tot_time_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;job_duration&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3600</span> <span class="o">/</span> <span class="n">n_parallel</span><span class="p">)</span>
        <span class="n">tot_time_sum_builds_and_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;build_duration&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3600</span> <span class="o">/</span> <span class="n">n_parallel</span><span class="p">)</span>
            <span class="o">+</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;job_duration&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3600</span> <span class="o">/</span> <span class="n">n_parallel</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">df_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df_time</span><span class="p">[</span><span class="s2">&quot;batches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_inspection_batches_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">df_time</span><span class="p">[</span><span class="s2">&quot;builds_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_time_builds</span>
    <span class="n">df_time</span><span class="p">[</span><span class="s2">&quot;jobs_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_time_jobs</span>
    <span class="n">df_time</span><span class="p">[</span><span class="s2">&quot;tot_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_time_sum_builds_and_jobs</span>

    <span class="k">return</span> <span class="n">df_time</span></div>


<div class="viewcode-block" id="create_scatter_plots_for_multiple_batches"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_scatter_plots_for_multiple_batches">[docs]</a><span class="k">def</span> <span class="nf">create_scatter_plots_for_multiple_batches</span><span class="p">(</span>
    <span class="n">inspection_df_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
    <span class="n">list_batches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">columns</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">title_scatter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
    <span class="n">x_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
    <span class="n">y_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create Scatter plots for multiple batches.</span>

<span class="sd">    :param inspection_df_dict: dictionary with data frame as returned by `process_inspection_results&#39; per identifier</span>
<span class="sd">    :param list_batches: list of batches to be used for correlation analysis</span>
<span class="sd">    :param columns: parameters to be considered, taken from data frame as returned by `process_inspection_results&#39;</span>
<span class="sd">    :param title_scatter: scatter plot name</span>
<span class="sd">    :param x_label: x label name</span>
<span class="sd">    :param y_label: y label name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">inspection_df_dict</span><span class="p">[</span><span class="n">list_batches</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">figure</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">inspection_df_dict</span><span class="p">[</span><span class="n">batch</span><span class="p">][</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">inspection_df_dict</span><span class="p">[</span><span class="n">batch</span><span class="p">][</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">batch</span><span class="p">,</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">list_batches</span>
        <span class="p">],</span>
        <span class="s2">&quot;layout&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title_scatter</span><span class="p">,</span> <span class="s2">&quot;xaxis&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">x_label</span><span class="p">},</span> <span class="s2">&quot;yaxis&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">y_label</span><span class="p">}},</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">figure</span></div>


<span class="c1"># General functions</span>


<div class="viewcode-block" id="create_scatter_and_correlation"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_scatter_and_correlation">[docs]</a><span class="k">def</span> <span class="nf">create_scatter_and_correlation</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">title_scatter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Scatter plot&quot;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create Scatter plot and evaluate correlation coefficients.&quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">figure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title_scatter</span><span class="p">,</span>
        <span class="n">xTitle</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">yTitle</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="n">asFigure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">correlation_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pearson&quot;</span><span class="p">,</span> <span class="s2">&quot;spearman&quot;</span><span class="p">,</span> <span class="s2">&quot;kendall&quot;</span><span class="p">]:</span>
        <span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">correlation_type</span><span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">correlation_type</span><span class="si">}</span><span class="s2"> correlation results:</span><span class="se">\n</span><span class="si">{</span><span class="n">correlation_matrix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">figure</span></div>


<div class="viewcode-block" id="create_plot_multiple_batches"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_plot_multiple_batches">[docs]</a><span class="k">def</span> <span class="nf">create_plot_multiple_batches</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span> <span class="ow">or</span> <span class="s2">&quot;hist&quot;</span><span class="p">,</span>
    <span class="n">x_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">y_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">static</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">save_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">project_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create (Histogram or Box) plot using several columns of the dataframe(static as default).&quot;&quot;&quot;</span>
    <span class="n">number_plots</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">quantity</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of plots created: </span><span class="si">{</span><span class="n">number_plots</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">static</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;box&quot;</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">quantity</span><span class="p">]</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xTitle</span><span class="o">=</span><span class="n">x_label</span><span class="p">,</span> <span class="n">yTitle</span><span class="o">=</span><span class="n">y_label</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;hist&quot;</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">quantity</span><span class="p">]</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;histogram&quot;</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xTitle</span><span class="o">=</span><span class="n">x_label</span><span class="p">,</span> <span class="n">yTitle</span><span class="o">=</span><span class="n">y_label</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">save_result</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Save figure: Not provided for interactive plot yet!!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">quantity</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">quantity</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Histogram </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> for</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">px</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
        <span class="n">px</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
        <span class="n">px</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_result</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">project_folder</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">current_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
                <span class="n">project_dir_path</span> <span class="o">=</span> <span class="n">current_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">project_folder</span><span class="p">)</span>

                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Project folder (if not already created!!)&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">project_dir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">folder_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">new_dir_path</span> <span class="o">=</span> <span class="n">project_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">folder_name</span><span class="p">)</span>
                    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating sub-folder (if not already created!!)&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_dir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_dir_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">_static.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_dir_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">_static.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="create_plot_from_df"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_plot_from_df">[docs]</a><span class="k">def</span> <span class="nf">create_plot_from_df</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">title_plot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
    <span class="n">x_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
    <span class="n">y_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
    <span class="n">static</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">save_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">project_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">scatter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create plot using two columns of the DataFrame.&quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Only two columns can be used!!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">static</span><span class="p">:</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;lines+markers&quot;</span>

        <span class="k">if</span> <span class="n">scatter</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;markers&quot;</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="p">}],</span>
            <span class="s2">&quot;layout&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title_plot</span><span class="p">,</span> <span class="s2">&quot;xaxis&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">x_label</span><span class="p">},</span> <span class="s2">&quot;yaxis&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">y_label</span><span class="p">}},</span>
        <span class="p">}</span>
        <span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_result</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Save figure: Not provided for interactive plot yet!!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">if</span> <span class="n">scatter</span><span class="p">:</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="n">title_plot</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="n">title_plot</span><span class="p">)</span>
    <span class="n">px</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
    <span class="n">px</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
    <span class="n">px</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_result</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">project_folder</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">current_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
            <span class="n">project_dir_path</span> <span class="o">=</span> <span class="n">current_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">project_folder</span><span class="p">)</span>

            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Project folder (if not already created!!)&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">project_dir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">folder_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">new_dir_path</span> <span class="o">=</span> <span class="n">project_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">folder_name</span><span class="p">)</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating sub-folder (if not already created!!)&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_dir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_dir_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">title_plot</span><span class="si">}</span><span class="s2">_static.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">title_plot</span><span class="si">}</span><span class="s2">_static.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No project folder name provided!!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_multiple_violin_plot"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.create_multiple_violin_plot">[docs]</a><span class="k">def</span> <span class="nf">create_multiple_violin_plot</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">x_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">y_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">save_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">project_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create violin plot.&quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">quantity</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating </span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">quantity</span><span class="p">][</span><span class="n">column_name</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="n">x_label</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Violin plot </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> for</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_result</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">project_folder</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">current_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
                <span class="n">project_dir_path</span> <span class="o">=</span> <span class="n">current_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">project_folder</span><span class="p">)</span>

                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Project folder (if not already created!!)&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">project_dir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">folder_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">new_dir_path</span> <span class="o">=</span> <span class="n">project_dir_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">folder_name</span><span class="p">)</span>
                    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating sub-folder (if not already created!!)&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_dir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_dir_path</span><span class="si">}</span><span class="s2">/Violin_plot_</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">_static.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project_dir_path</span><span class="si">}</span><span class="s2">/Violin_plot_</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">_static.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No project folder name provided!!&quot;</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="columns_to_analyze"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.columns_to_analyze">[docs]</a><span class="k">def</span> <span class="nf">columns_to_analyze</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">display_clusters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cluster_by_hue</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Print all columns within dataframe and count of unique column values within limit.</span>

<span class="sd">    :param df: data frame to analyze as returned by `process_inspection_results&#39;</span>
<span class="sd">    :param low: the lower limit (0 if not specified) of distinct value counts</span>
<span class="sd">    :param display_clusters: if true, displays grouped counts of parameter and parameter sort_values</span>
<span class="sd">    :param cluster_by_hue: if true, displays distribution of parameters to analyze sorted by hues</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lst_columns_to_analyze</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">high</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Groups every column by unique values</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#### Columns to analyze, Unique Value Count&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">value_count</span> <span class="o">&gt;=</span> <span class="n">low</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value_count</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value_count</span><span class="p">)</span>
                <span class="n">lst_columns_to_analyze</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># Groups every column by unique values if values are in list or dict formats</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">value_count</span> <span class="o">&gt;=</span> <span class="n">low</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value_count</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value_count</span><span class="p">)</span>
                    <span class="n">lst_columns_to_analyze</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">lst_new</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">value_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst_new</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lst_new</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">value_count</span> <span class="o">&gt;=</span> <span class="n">low</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value_count</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value_count</span><span class="p">)</span>
                    <span class="n">lst_columns_to_analyze</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">pass</span>

    <span class="c1"># Filters data frame to columns with distinct value counts within the limit</span>
    <span class="n">df_analyze</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">lst_columns_to_analyze</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">display_clusters</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#### Inspection result count organized by parameter + parameter values&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">display_jobs_by_subcategories</span><span class="p">(</span><span class="n">df_analyze</span><span class="p">):</span>
                <span class="n">display</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">cluster_by_hue</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#### Distribution of parameters to analyze organized by hues&quot;</span><span class="p">)</span>
            <span class="n">plot_subcategories_by_hues</span><span class="p">(</span><span class="n">df_analyze</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="s2">&quot;status__job__duration&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;##### Parameter variance too large to plot by hue/color&quot;</span><span class="p">)</span>

    <span class="c1"># In addition to printing, function returns dataframe with results that fall within the limits</span>

    <span class="k">return</span> <span class="n">df_analyze</span></div>


<div class="viewcode-block" id="display_jobs_by_subcategories"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.display_jobs_by_subcategories">[docs]</a><span class="k">def</span> <span class="nf">display_jobs_by_subcategories</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create dataframe with job counts for each subcategory for every column in the data frame.</span>

<span class="sd">    :param df: dataframe with columns of unique value counts as returned by columns_to_analyze</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Introduce index column for job counts</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">created_values</span> <span class="o">=</span> <span class="n">query_inspection_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span>
                <span class="n">df_inspection_id</span> <span class="o">=</span> <span class="n">created_values</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
                <span class="n">df_inspection_id</span> <span class="o">=</span> <span class="n">df_inspection_id</span><span class="o">.</span><span class="n">filter</span><span class="p">([</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_inspection_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lst</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># Error given if column values in dataframe are constant</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Some or all columns passed in are not distinct in values&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="duration_plots"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.duration_plots">[docs]</a><span class="k">def</span> <span class="nf">duration_plots</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create plots for job and build duration, elapsed time, and lead time.</span>

<span class="sd">    :param df: data frame with duration information as returned by process_inspection_results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">321</span><span class="p">)</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">322</span><span class="p">)</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">323</span><span class="p">)</span>
    <span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">324</span><span class="p">)</span>
    <span class="n">ax5</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">325</span><span class="p">)</span>
    <span class="n">ax6</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">326</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Create value lead_time as: created to status__job__started_at</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;lead_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;status__job__started_at&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">])</span>

    <span class="c1"># Plot job__duration from inspection results</span>
    <span class="n">s_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;status__job__duration&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;DarkBlue&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Job Duration&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
    <span class="n">s_plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;status__job__duration [ms]&quot;</span><span class="p">)</span>

    <span class="c1"># Plot build__duration from inspection results</span>
    <span class="n">s_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;status__build__duration&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;DarkBlue&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Build Duration&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
    <span class="n">s_plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;status__job__duration [ms]&quot;</span><span class="p">)</span>

    <span class="c1"># Plot elapsed time from inspection results</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;job_log__stdout__@result__elapsed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;job_log__stdout__@result__elapsed&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="n">s_plot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;job_log__stdout__@result__elapsed&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;DarkBlue&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Elapsed Duration&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span>
    <span class="p">)</span>
    <span class="n">s_plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;elapsed [ms]&quot;</span><span class="p">)</span>

    <span class="c1"># Plot lag plot of job duration sorted by the start of job</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;status__job__started_at&quot;</span><span class="p">])</span>
    <span class="n">lag_plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;status__job__duration&quot;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Job Duration Autocorrelation (Sort by job_started)&quot;</span><span class="p">)</span>

    <span class="c1"># Plot lag plot of lead time sorted by job created</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">])</span>
    <span class="n">lag_plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lead_time&quot;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax5</span><span class="p">)</span>
    <span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;lead_duration Autocorrelation (Sort by created)&quot;</span><span class="p">)</span>

    <span class="c1"># Plot lag plot of lead time sorted by job started</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;status__job__started_at&quot;</span><span class="p">])</span>
    <span class="n">lag_plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;lead_time&quot;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax6</span><span class="p">)</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;lead_duration Autocorrelation (Sort by job_started)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_subcategories_by_hues"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.plot_subcategories_by_hues">[docs]</a><span class="k">def</span> <span class="nf">plot_subcategories_by_hues</span><span class="p">(</span><span class="n">df_cat</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create scatter plots with parameter categories separated by hues.</span>

<span class="sd">    :param df_cat: filtered dataframe with columns to analyze as returned by columns_to_analyze</span>
<span class="sd">    :param df: data frame with duration information as returned by process_inspection_results</span>
<span class="sd">    :param colum: job duration/build duration columns from &#39;df&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df_cat</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">margin_titles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">fit_reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">x_jitter</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">scatter_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_legend</span><span class="p">()</span></div>


<div class="viewcode-block" id="concatenated_df"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.concatenated_df">[docs]</a><span class="k">def</span> <span class="nf">concatenated_df</span><span class="p">(</span><span class="n">dfs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reorganize dataframe to show the distribution of jobs in a category across different subsets of data.</span>

<span class="sd">    :param dfs: list of inspection result dataframes which can be different datasets or subset of datasets</span>
<span class="sd">    :param column: column name or category for grouping to see the distribution of results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lst_processed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_grouping_category</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">column</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">col_one</span> <span class="o">=</span> <span class="n">df_grouping_category</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="n">df_col_one</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">col_one</span><span class="p">)</span>
        <span class="n">df_col_one</span> <span class="o">=</span> <span class="n">df_col_one</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;Total jobs:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">))})</span>
        <span class="n">lst_processed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_col_one</span><span class="p">)</span>

    <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst_processed</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_final</span></div>


<div class="viewcode-block" id="summary_trace_plot"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.summary_trace_plot">[docs]</a><span class="k">def</span> <span class="nf">summary_trace_plot</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_categories</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">dfs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create trace plot scaled by percentage of compositions of each parameter separated by hues.</span>

<span class="sd">    :param df: data frame with duration information as returned by process_inspection_results</span>
<span class="sd">    :param df_categories: filtered dataframe with columns to analyze as returned by columns_to_analyze</span>
<span class="sd">    :param dfs: dataframes of clustered data (if any) appended to dataframe of</span>
<span class="sd">    entire dataset (ie: [df_left_cluster, df_right_cluster, df_duration])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dfs</span><span class="p">:</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_categories</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">lst_df</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df_categories</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">lst_df</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">concatenated_df</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
    <span class="n">lst_to_analyze</span> <span class="o">=</span> <span class="n">df_categories</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_categories</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_categories</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lst_df</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">lst_to_analyze</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="summary_bar_plot"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.summary_bar_plot">[docs]</a><span class="k">def</span> <span class="nf">summary_bar_plot</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_categories</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Create trace stacked plot scaled by total jobs of each parameter within clusters (if any).</span>

<span class="sd">    :param df: data frame with duration information as returned by process_inspection_results</span>
<span class="sd">    :param df_categories:  filtered dataframe with columns to analyze as returned by columns_to_analyze</span>
<span class="sd">    :param clusters: list of subset dataframes with the last value in list being the entire data set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_categories</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">*</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">lst_df</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of dataframes, dataframe for each cluster</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df_categories</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">lst_df</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">concatenated_df</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>

    <span class="n">lst_to_analyze</span> <span class="o">=</span> <span class="n">df_categories</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst_df</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_categories</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">lst_to_analyze</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#addd8e&quot;</span><span class="p">,</span> <span class="s2">&quot;#fdd0a2&quot;</span><span class="p">,</span> <span class="s2">&quot;#a6bddb&quot;</span><span class="p">,</span> <span class="s2">&quot;#7fcdbb&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lst_cluster</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">lst_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Total jobs:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
            <span class="n">g</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">lst_df</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">lst_cluster</span><span class="p">]</span>
                <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">align</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;barh&quot;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lst_df</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
            <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;Total jobs:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))]]</span>
            <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">align</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;barh&quot;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#7fcdbb&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_offset</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.2</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">patches</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_bbox</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">x1</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">((</span><span class="n">b</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="plot_distribution_of_jobs_combined_categories"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.plot_distribution_of_jobs_combined_categories">[docs]</a><span class="k">def</span> <span class="nf">plot_distribution_of_jobs_combined_categories</span><span class="p">(</span>
    <span class="n">df_hardware_category</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_duration</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df_analyze</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the job duration distribution for each unique hardware combination/configuration of data.</span>

<span class="sd">    :param df_hardware_category: dataframe of of parameters to analyze grouped by distinct rows</span>
<span class="sd">    :param df_duration:  dataframe with duration information as returned by process_inspection_results</span>
<span class="sd">    :param df_analyze: dataframe of parameters that show variation across the clusters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">list_df_combinations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_hardware_category</span><span class="p">)):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_hardware_category</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">df_analyze</span><span class="p">[</span><span class="n">df_hardware_category</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">==</span> <span class="n">df_hardware_category</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>
        <span class="n">df_new</span> <span class="o">=</span> <span class="n">df_duration</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">values</span><span class="p">)]</span>

        <span class="n">list_df_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_new</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_hardware_category</span><span class="p">)))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_hardware_category</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_hardware_category</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">list_df_combinations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;status__job__duration&quot;</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">df_hardware_category</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span></div>


<span class="c1"># Function takes in a column and prints out the feature class</span>
<div class="viewcode-block" id="map_column_to_feature_class"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.map_column_to_feature_class">[docs]</a><span class="k">def</span> <span class="nf">map_column_to_feature_class</span><span class="p">(</span><span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function that maps a column in the original dataframe to a feature class.</span>

<span class="sd">    :param column_name: column_name in inspection_df dataframe</span>
<span class="sd">    obtained by process_inspection_results with no columns dropped (drop=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The keys are keywords to help associate each column with the corresponding feature class.</span>
    <span class="n">software_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;specification__files&quot;</span><span class="p">,</span> <span class="s2">&quot;specification__packages&quot;</span><span class="p">,</span> <span class="s2">&quot;specification__python__requirements&quot;</span><span class="p">]</span>
    <span class="n">script_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;job_log__script&quot;</span><span class="p">,</span> <span class="s2">&quot;job_log__stderr&quot;</span><span class="p">,</span> <span class="s2">&quot;job_log__stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;specification__script&quot;</span><span class="p">]</span>
    <span class="n">hardware_keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;hwinfo__cpu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;platform__architecture&quot;</span><span class="p">,</span>
        <span class="s2">&quot;platform__machine&quot;</span><span class="p">,</span>
        <span class="s2">&quot;platform__platform&quot;</span><span class="p">,</span>
        <span class="s2">&quot;platform__processor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;platform__release&quot;</span><span class="p">,</span>
        <span class="s2">&quot;platform__version&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">column_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hardware_keys</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Hardware (ncpus + Platform + Processor)&quot;</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">column_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">software_keys</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Software stack (files, python packages, python requirements)&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;specification__base&quot;</span> <span class="ow">in</span> <span class="n">column_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Base image&quot;</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">column_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">script_keys</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Script (script + sha256 + parameters)&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;build__requests&quot;</span> <span class="ow">in</span> <span class="n">column_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Build request (hardware + memory)&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;run__requests&quot;</span> <span class="ow">in</span> <span class="n">column_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Run request (hardware + memory)&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;build__exit_code&quot;</span> <span class="ow">in</span> <span class="n">column_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Failure build (exit_code)&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;job__exit_code&quot;</span> <span class="ow">in</span> <span class="n">column_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Failure run/job (exit_code)&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;job_log__exit_code&quot;</span> <span class="ow">in</span> <span class="n">column_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Job Log (exit_code)&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Inspection Result Info&quot;</span></div>


<div class="viewcode-block" id="process_empty_or_mutable_parameters"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.process_empty_or_mutable_parameters">[docs]</a><span class="k">def</span> <span class="nf">process_empty_or_mutable_parameters</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process empty or mutable parameters in dataframe.</span>

<span class="sd">    These values will not work with further processing using the groupby function. Prints the unique</span>
<span class="sd">    value count of all columns that are unhashable (all such columns are constant). Drops these</span>
<span class="sd">    columns and returns a new dataframe.</span>

<span class="sd">    :param inspection_df: data frame as returned by `process_inspection_results`</span>
<span class="sd">    with no columns dropped (drop=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This is a list to populate with columns with no data or columns with unhashable data.</span>
    <span class="n">list_of_unhashable_none_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inspection_df</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspection_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

            <span class="c1"># Columns with no data</span>
            <span class="k">if</span> <span class="n">value_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value_count</span><span class="p">)</span>
                <span class="n">list_of_unhashable_none_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># Groups every column by unique values if values are in list or dict formats</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If values are type list checks uniqueness</span>
                <span class="n">value_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="n">list_of_unhashable_none_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value_count</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># If values are type dict checks uniqueness</span>
                <span class="n">lst_new</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">value_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst_new</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lst_new</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]])</span>
                <span class="n">list_of_unhashable_none_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value_count</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inspection_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">list_of_unhashable_none_values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_unique_value_count_by_feature_class"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.show_unique_value_count_by_feature_class">[docs]</a><span class="k">def</span> <span class="nf">show_unique_value_count_by_feature_class</span><span class="p">(</span><span class="n">processed_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show unique count values per feature/class.</span>

<span class="sd">    Show results per feature/class that are subdivided in subclasses that map to it.</span>

<span class="sd">    :param processed_df: processed dataframe as returned by the process_empty_or_mutable_parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dict_to_feature_class</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">list_of_features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Iterate through dataframe and create a dictionary of dataframe column: feature class key value pairs.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">processed_df</span><span class="p">:</span>
        <span class="n">dict_to_feature_class</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_column_to_feature_class</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">list_of_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_column_to_feature_class</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="c1"># Get list of distinct feature class labels (this is generalized to accomodate changes made to the label)</span>
    <span class="n">list_of_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list_of_features</span><span class="p">)</span>

    <span class="c1"># Iterate through every feature class</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">list_of_features</span><span class="p">:</span>
        <span class="c1"># Get a list of parameters that fall within the class</span>
        <span class="n">list_of_parameters_per_feature</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dict_to_feature_class</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">dict_to_feature_class</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">list_of_parameters_per_feature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="c1"># Groupby to get unique value count for feature class</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">processed_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">list_of_parameters_per_feature</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#### </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)))</span>

            <span class="c1"># Groupby to get unique value count for each dataframe column</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">list_of_parameters_per_feature</span><span class="p">:</span>
                <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Parameter does not have any values. Filter these out first&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="dataframe_statistics"><a class="viewcode-back" href="../../../thoth.lab.html#thoth.lab.inspection.dataframe_statistics">[docs]</a><span class="k">def</span> <span class="nf">dataframe_statistics</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">plot_title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Output a data frame with relevant statistics on job duration, build duration and time elapsed.</span>

<span class="sd">    :param inspection_df: data frame to analyze as returned by `process_inspection_results&#39; (duration [ms])</span>
<span class="sd">    :param plot_title: title of fit plot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Measure of skew and kurtosis for job and build duration</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#### Skew and kurtosis statistics&quot;</span><span class="p">)</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job Duration Skew: </span><span class="si">{</span><span class="n">inspection_df</span><span class="p">[</span><span class="s1">&#39;status__job__duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Build Duration Skew:: </span><span class="si">{</span><span class="n">inspection_df</span><span class="p">[</span><span class="s1">&#39;status__build__duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job Duration Kurtosis: </span><span class="si">{</span><span class="n">inspection_df</span><span class="p">[</span><span class="s1">&#39;status__job__duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kurt</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Build Duration Kurtosis: </span><span class="si">{</span><span class="n">inspection_df</span><span class="p">[</span><span class="s1">&#39;status__build__duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kurt</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Statistics for job duration, build duration, and elapsed time</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#### Duration statistics&quot;</span><span class="p">)</span>
    <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="n">inspection_df</span><span class="p">[</span><span class="s2">&quot;status__job__duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()))</span>
    <span class="n">df_stats</span><span class="p">[</span><span class="s2">&quot;status__build__duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspection_df</span><span class="p">[</span><span class="s2">&quot;status__build__duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
    <span class="n">df_stats</span><span class="p">[</span><span class="s2">&quot;job_log__stdout__@result__elapsed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">inspection_df</span><span class="p">[</span><span class="s2">&quot;job_log__stdout__@result__elapsed&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df_stats</span><span class="p">)</span>

    <span class="c1"># Plotting of job duration and build duration with fit</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">[</span><span class="s2">&quot;status__job__duration&quot;</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Job Duration: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plot_title</span><span class="p">))</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#### Job and build distribution plots, scatter plots, autocorrelation plots&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">inspection_df</span><span class="p">[</span><span class="s2">&quot;status__build__duration&quot;</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">g2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Build Duration: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plot_title</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">duration_plots</span><span class="p">(</span><span class="n">df_stats</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation index</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123174547-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-123174547-1');
    </script>

  </body>
</html>